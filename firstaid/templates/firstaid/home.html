{% extends "base.html" %}
{% load static %}

{% block title %}First AID - AI Documentation Assistant{% endblock %}

{% block extra_head %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- DOMPurify for HTML sanitization -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<style>
    .firstaid-container {
        display: flex;
        height: calc(100vh - 60px);
        gap: 0;
    }
    
    .firstaid-panel {
        border-right: 1px solid var(--bs-border-color);
        overflow-y: auto;
        padding: 1rem;
    }
    
    .firstaid-panel-left {
        width: 400px;
        min-width: 300px;
        position: sticky;
        top: 0;
        height: calc(100vh - 60px);
    }
    
    .firstaid-panel-middle {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0; /* Allows text truncation/wrapping in flex containers */
    }
    
    .firstaid-panel-right {
        width: 320px;
        min-width: 280px;
        position: sticky;
        top: 0;
        height: calc(100vh - 60px);
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: calc(100vh - 260px);
    }
    
    .chat-input-area {
        border-top: 1px solid var(--bs-border-color);
        padding: 1rem;
        background: var(--bs-body-bg);
    }
    
    .message {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        max-width: 80%;
        position: relative;
    }
    
    .message-user {
        align-self: flex-end;
        background: var(--bs-primary);
        color: white;
    }
    
    .message-assistant {
        align-self: flex-start;
        background: var(--bs-secondary-bg);
    }
    
    .message-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .message-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
    }
    
    .message-icon-ai {
        background: var(--bs-info);
        color: white;
    }
    
    .message-icon-user {
        background: var(--bs-success);
        color: white;
    }
    
    .message-copy-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .message:hover .message-copy-btn {
        opacity: 1;
    }
    
    .source-item {
        padding: 0.5rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .source-item:hover {
        background: var(--bs-secondary-bg);
    }
    
    .source-item-selected {
        background: var(--bs-primary);
        color: white;
    }
    
    .source-item-title {
        word-break: break-word;
        overflow-wrap: break-word;
    }
    
    /* Accordion customization */
    .accordion-button {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
    }
    
    .accordion-body {
        padding: 0.5rem;
    }
    
    /* Tool tiles */
    .tools-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }
    
    .tool-tile {
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bs-body-bg);
    }
    
    .tool-tile:hover {
        background: var(--bs-secondary-bg);
        border-color: var(--bs-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .tool-tile:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .tool-tile:disabled:hover {
        transform: none;
        box-shadow: none;
    }
    
    .tool-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: var(--bs-primary);
    }
    
    .tool-title {
        font-size: 0.75rem;
        font-weight: 500;
        margin: 0;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner 0.75s linear infinite;
    }
    
    @keyframes spinner {
        to { transform: rotate(360deg); }
    }
    
    /* Markdown viewer for modals */
    .markdown-viewer {
        line-height: 1.6;
    }
    
    .markdown-viewer h1,
    .markdown-viewer h2,
    .markdown-viewer h3,
    .markdown-viewer h4,
    .markdown-viewer h5,
    .markdown-viewer h6 {
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }
    
    .markdown-viewer h1 {
        font-size: 1.75rem;
        border-bottom: 1px solid var(--bs-border-color);
        padding-bottom: 0.3rem;
    }
    
    .markdown-viewer h2 {
        font-size: 1.5rem;
        border-bottom: 1px solid var(--bs-border-color);
        padding-bottom: 0.3rem;
    }
    
    .markdown-viewer code {
        background-color: var(--bs-secondary-bg);
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-family: 'Courier New', monospace;
    }
    
    .markdown-viewer pre {
        background-color: var(--bs-secondary-bg);
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
    }
    
    .markdown-viewer pre code {
        background-color: transparent;
        padding: 0;
    }
    
    .markdown-viewer blockquote {
        border-left: 4px solid var(--bs-border-color);
        padding-left: 1rem;
        margin-left: 0;
        color: var(--bs-secondary-color);
    }
    
    .markdown-viewer ul,
    .markdown-viewer ol {
        padding-left: 2rem;
    }
    
    .markdown-viewer a {
        color: var(--bs-link-color);
        text-decoration: none;
    }
    
    .markdown-viewer a:hover {
        text-decoration: underline;
    }
    
    .markdown-viewer table {
        border-collapse: collapse;
        width: 100%;
        margin: 1rem 0;
    }
    
    .markdown-viewer table th,
    .markdown-viewer table td {
        border: 1px solid var(--bs-border-color);
        padding: 0.5rem 0.75rem;
    }
    
    .markdown-viewer table th {
        background-color: var(--bs-secondary-bg);
        font-weight: bold;
    }
    
    /* Responsive layout */
    @media (max-width: 768px) {
        .firstaid-container {
            flex-direction: column;
        }
        
        .firstaid-panel-left,
        .firstaid-panel-right {
            width: 100%;
            position: relative;
            height: auto;
            max-height: 300px;
        }
        
        .tools-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Project Selector -->
    <div class="bg-dark border-bottom p-2">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-auto">
                    <strong><i class="bi bi-heart-pulse-fill text-danger"></i> First AID</strong>
                </div>
                <div class="col">
                    <select id="project-selector" class="form-select form-select-sm" style="max-width: 400px;">
                        <option value="">Select a project...</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" {% if selected_project and selected_project.id == project.id %}selected{% endif %}>
                            {{ project.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3-Column Layout -->
    <div class="firstaid-container">
        <!-- Left Panel: Sources -->
        <div class="firstaid-panel firstaid-panel-left">
            <h6 class="border-bottom pb-2 mb-3">
                <i class="bi bi-folder2-open"></i> Sources
            </h6>
            
            <div id="sources-container">
                {% if selected_project %}
                    {% include "firstaid/partials/sources.html" %}
                {% else %}
                    <p class="text-muted small">Select a project to view sources.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Middle Panel: Chat -->
        <div class="firstaid-panel-middle">
            <div class="chat-messages" id="chat-messages">
                {% if selected_project %}
                    <div class="message message-assistant">
                        <div class="message-header">
                            <div class="message-icon message-icon-ai">
                                <i class="bi bi-robot"></i>
                            </div>
                            <strong>First AID</strong>
                        </div>
                        <p class="mb-0">
                            Hello! I'm your AI documentation assistant. I have access to all items, issues, pull requests, and attachments in the <strong>{{ selected_project.name }}</strong> project.
                        </p>
                        <p class="mb-0 mt-2">
                            Ask me anything about this project, and I can help you:
                        </p>
                        <ul class="mb-0 mt-1">
                            <li>Answer questions based on project knowledge</li>
                            <li>Generate documentation</li>
                            <li>Create knowledge base articles</li>
                            <li>Make flashcards for learning</li>
                            <li>Create new issues</li>
                        </ul>
                    </div>
                {% else %}
                    <div class="message message-assistant">
                        <div class="message-header">
                            <div class="message-icon message-icon-ai">
                                <i class="bi bi-robot"></i>
                            </div>
                            <strong>First AID</strong>
                        </div>
                        <p class="mb-0">
                            Welcome to First AID - your AI documentation assistant!
                        </p>
                        <p class="mb-0 mt-2">
                            Please select a project from the dropdown above to get started.
                        </p>
                    </div>
                {% endif %}
            </div>
            
            <div class="chat-input-area">
                <div class="mb-2">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <label for="thinking-level" class="form-label mb-0 small">Thinking Level:</label>
                        </div>
                        <div class="col-auto">
                            <select id="thinking-level" class="form-select form-select-sm" style="width: auto;" 
                                    aria-label="Select thinking level for content detail">
                                <option value="standard" selected>Standard (3000) - Faster responses</option>
                                <option value="erweitert">Erweitert (6000) - More detailed</option>
                                <option value="professionell">Professionell (10000) - Maximum detail</option>
                            </select>
                        </div>
                        <div class="col-auto ms-auto">
                            <button type="button" 
                                    class="btn btn-sm btn-outline-secondary" 
                                    id="clear-chat-btn"
                                    aria-label="Clear chat history"
                                    {% if not selected_project %}disabled{% endif %}>
                                <i class="bi bi-trash" aria-hidden="true"></i> Clear History
                            </button>
                        </div>
                    </div>
                </div>
                <form id="chat-form">
                    <label for="chat-input" class="form-label visually-hidden">Ask a question about the project</label>
                    <div class="input-group">
                        <textarea id="chat-input" 
                                  class="form-control" 
                                  rows="3"
                                  placeholder="Ask a question about the project..."
                                  aria-label="Ask a question about the project"
                                  {% if not selected_project %}disabled{% endif %}></textarea>
                        <button type="submit" 
                                class="btn btn-primary" 
                                id="chat-submit"
                                style="align-self: flex-end;"
                                {% if not selected_project %}disabled{% endif %}>
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Right Panel: Tools -->
        <div class="firstaid-panel firstaid-panel-right">
            <h6 class="border-bottom pb-2 mb-3">
                <i class="bi bi-tools"></i> Tools
            </h6>
            
            <div class="tools-grid">
                <button class="tool-tile" 
                        id="tool-kb-article"
                        {% if not selected_project %}disabled{% endif %}>
                    <div class="tool-icon">
                        <i class="bi bi-journal-text"></i>
                    </div>
                    <p class="tool-title">KB Article</p>
                </button>
                
                <button class="tool-tile" 
                        id="tool-documentation"
                        {% if not selected_project %}disabled{% endif %}>
                    <div class="tool-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <p class="tool-title">Documentation</p>
                </button>
                
                <button class="tool-tile" 
                        id="tool-flashcards"
                        {% if not selected_project %}disabled{% endif %}>
                    <div class="tool-icon">
                        <i class="bi bi-card-heading"></i>
                    </div>
                    <p class="tool-title">Flashcards</p>
                </button>
                
                <button class="tool-tile" 
                        id="tool-create-issue"
                        {% if not selected_project %}disabled{% endif %}>
                    <div class="tool-icon">
                        <i class="bi bi-bug"></i>
                    </div>
                    <p class="tool-title">Create Issue</p>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for displaying generated content -->
<div class="modal fade" id="contentModal" tabindex="-1" aria-labelledby="contentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contentModalLabel">Generated Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body markdown-viewer" id="contentModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadContentBtn">
                    <i class="bi bi-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for displaying flashcards -->
<div class="modal fade" id="flashcardsModal" tabindex="-1" aria-labelledby="flashcardsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="flashcardsModalLabel">Generated Flashcards</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="flashcardsModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const projectSelector = document.getElementById('project-selector');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const chatSubmit = document.getElementById('chat-submit');
    const sourcesContainer = document.getElementById('sources-container');
    const thinkingLevel = document.getElementById('thinking-level');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    
    let selectedProjectId = '{{ selected_project.id|default:"" }}';
    let chatContext = [];
    let currentGeneratedContent = '';
    let currentContentFilename = '';
    
    // Event delegation for copy buttons
    chatMessages.addEventListener('click', function(e) {
        const copyBtn = e.target.closest('.copy-message-btn');
        if (copyBtn) {
            const content = copyBtn.getAttribute('data-message-content');
            if (content) {
                copyToClipboard(content);
            }
        }
    });
    
    // Project selector change
    projectSelector.addEventListener('change', function() {
        const projectId = this.value;
        if (projectId) {
            window.location.href = '{% url "firstaid:home" %}?project=' + projectId;
        }
    });
    
    // Clear chat history
    clearChatBtn.addEventListener('click', async function() {
        if (!selectedProjectId) return;
        
        if (!confirm('Are you sure you want to clear the chat history?')) {
            return;
        }
        
        try {
            const response = await fetch('{% url "firstaid:clear-chat-history" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrf-token]').content,
                },
                body: JSON.stringify({
                    project_id: selectedProjectId,
                }),
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Clear the chat messages display
                const welcomeMsg = chatMessages.querySelector('.message-assistant');
                chatMessages.innerHTML = '';
                if (welcomeMsg) {
                    chatMessages.appendChild(welcomeMsg.cloneNode(true));
                }
                
                // Clear context
                chatContext = [];
                
                // Show success message
                addMessage('assistant', 'Chat history has been cleared.');
            } else {
                alert('Error clearing chat history: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error clearing chat history:', error);
            alert('Error: Could not clear chat history');
        }
    });
    
    // Chat form submission
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const question = chatInput.value.trim();
        if (!question || !selectedProjectId) return;
        
        // Add user message
        addMessage('user', question);
        chatInput.value = '';
        
        // Show loading
        chatSubmit.disabled = true;
        chatSubmit.innerHTML = '<span class="loading-spinner"></span> Thinking...';
        
        try {
            const response = await fetch('{% url "firstaid:chat" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrf-token]').content,
                },
                body: JSON.stringify({
                    question: question,
                    project_id: selectedProjectId,
                    thinking_level: thinkingLevel.value,
                }),
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Add assistant message
                addMessage('assistant', data.answer);
                
                // Store in context
                chatContext.push({
                    question: question,
                    answer: data.answer,
                    sources: data.sources,
                });
            } else {
                addMessage('assistant', 'Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Chat error:', error);
            addMessage('assistant', 'Error: Could not connect to the server');
        } finally {
            chatSubmit.disabled = false;
            chatSubmit.innerHTML = '<i class="bi bi-send"></i> Send';
        }
    });
    
    // Helper function to add messages
    function addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message-' + role;
        
        // Create message header with icon
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        
        const iconDiv = document.createElement('div');
        iconDiv.className = 'message-icon message-icon-' + (role === 'assistant' ? 'ai' : 'user');
        iconDiv.innerHTML = role === 'assistant' ? '<i class="bi bi-robot"></i>' : '<i class="bi bi-person-fill"></i>';
        
        const nameStrong = document.createElement('strong');
        nameStrong.textContent = role === 'assistant' ? 'First AID' : 'You';
        
        headerDiv.appendChild(iconDiv);
        headerDiv.appendChild(nameStrong);
        
        // Create copy button
        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-sm btn-outline-secondary message-copy-btn';
        copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
        copyBtn.title = 'Copy to clipboard';
        copyBtn.setAttribute('data-message-content', content);
        copyBtn.classList.add('copy-message-btn');
        
        // Create content div
        const contentDiv = document.createElement('div');
        contentDiv.className = 'mt-1';
        
        if (role === 'assistant' && typeof marked !== 'undefined') {
            // Render markdown for assistant messages and sanitize with DOMPurify
            const rawHtml = marked.parse(content);
            if (typeof DOMPurify !== 'undefined') {
                contentDiv.innerHTML = DOMPurify.sanitize(rawHtml);
            } else {
                // Fallback: use plain text if DOMPurify is not available to prevent XSS
                console.warn('DOMPurify not available, falling back to plain text rendering');
                contentDiv.textContent = content;
            }
        } else {
            // Plain text for user messages
            contentDiv.textContent = content;
        }
        
        messageDiv.appendChild(headerDiv);
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(copyBtn);
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Copy to clipboard function
    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() {
                showToast('Copied to clipboard!');
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
            });
        } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard!');
            } catch (err) {
                console.error('Fallback: Could not copy text: ', err);
            }
            document.body.removeChild(textArea);
        }
    }
    
    // Simple toast notification
    function showToast(message) {
        // Check if there's already a toast container
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        toast.className = 'alert alert-success alert-dismissible fade show';
        toast.setAttribute('role', 'alert');
        toast.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
        
        toastContainer.appendChild(toast);
        
        // Auto-remove after 3 seconds
        setTimeout(function() {
            toast.remove();
        }, 3000);
    }
    
    // Tool buttons
    document.getElementById('tool-kb-article').addEventListener('click', async function() {
        await executeTool('kb-article', 'KB Article');
    });
    
    document.getElementById('tool-documentation').addEventListener('click', async function() {
        await executeTool('documentation', 'Documentation');
    });
    
    document.getElementById('tool-flashcards').addEventListener('click', async function() {
        await executeTool('flashcards', 'Flashcards');
    });
    
    document.getElementById('tool-create-issue').addEventListener('click', async function() {
        await executeTool('create-issue', 'Create Issue');
    });
    
    // Execute tool action
    async function executeTool(toolType, toolName) {
        if (chatContext.length === 0) {
            alert('Please have a conversation first before using tools.');
            return;
        }
        
        // Build context from chat history
        const context = chatContext.map(item => 
            `Q: ${item.question}\nA: ${item.answer}`
        ).join('\n\n');
        
        // Show loading modal or toast
        showToast('Generating ' + toolName + '...');
        
        let url, payload;
        
        if (toolType === 'create-issue') {
            // For create-issue, we need title and description
            const lastItem = chatContext[chatContext.length - 1];
            payload = {
                title: lastItem.question,
                description: lastItem.answer,
                project_id: selectedProjectId,
            };
            url = '{% url "firstaid:create-issue" %}';
        } else {
            payload = {
                context: context,
                project_id: selectedProjectId,
            };
            // Build URL based on tool type
            if (toolType === 'kb-article') {
                url = '{% url "firstaid:generate-kb-article" %}';
            } else if (toolType === 'documentation') {
                url = '{% url "firstaid:generate-documentation" %}';
            } else if (toolType === 'flashcards') {
                url = '{% url "firstaid:generate-flashcards" %}';
            }
        }
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrf-token]').content,
                },
                body: JSON.stringify(payload),
            });
            
            const data = await response.json();
            
            if (response.ok) {
                if (toolType === 'flashcards') {
                    displayFlashcardsModal(data.flashcards);
                } else if (toolType === 'create-issue') {
                    showToast('Issue created successfully!');
                    // Optionally open the issue in a new tab
                    if (data.url) {
                        window.open(data.url, '_blank');
                    }
                } else {
                    displayContentModal(data.content, data.title);
                }
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Tool execution error:', error);
            alert('Error: Could not execute tool');
        }
    }
    
    // Display content in modal
    function displayContentModal(content, title) {
        currentGeneratedContent = content;
        // Sanitize filename by removing invalid characters
        currentContentFilename = title.replace(/[/\\:*?"<>|]/g, '_').replace(/\s+/g, '_') + '.md';
        
        const modal = new bootstrap.Modal(document.getElementById('contentModal'));
        document.getElementById('contentModalLabel').textContent = title;
        
        const bodyElement = document.getElementById('contentModalBody');
        if (typeof marked !== 'undefined') {
            const rawHtml = marked.parse(content);
            if (typeof DOMPurify !== 'undefined') {
                bodyElement.innerHTML = DOMPurify.sanitize(rawHtml);
            } else {
                // Fallback: use plain text if DOMPurify is not available to prevent XSS
                console.warn('DOMPurify not available, displaying as plain text');
                const pre = document.createElement('pre');
                pre.textContent = content;
                bodyElement.innerHTML = '';
                bodyElement.appendChild(pre);
            }
        } else {
            const pre = document.createElement('pre');
            pre.textContent = content;
            bodyElement.innerHTML = '';
            bodyElement.appendChild(pre);
        }
        
        modal.show();
    }
    
    // Display flashcards in modal
    function displayFlashcardsModal(flashcards) {
        const modal = new bootstrap.Modal(document.getElementById('flashcardsModal'));
        const bodyElement = document.getElementById('flashcardsModalBody');
        
        let html = '';
        flashcards.forEach((card, index) => {
            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>Card ${index + 1}</strong>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><strong>Q:</strong> ${card.question}</p>
                        <p class="card-text text-muted"><strong>A:</strong> ${card.answer}</p>
                    </div>
                </div>
            `;
        });
        
        bodyElement.innerHTML = html;
        modal.show();
    }
    
    // Download content button
    document.getElementById('downloadContentBtn').addEventListener('click', function() {
        downloadAsFile(currentContentFilename, currentGeneratedContent);
    });
});

// Download as file helper
function downloadAsFile(filename, content) {
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
