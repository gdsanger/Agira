{% extends "base.html" %}
{% load django_tables2 %}
{% load i18n %}

{% block title %}{{ page_title }} - Agira{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h1>{{ page_title }}</h1>
            <p class="text-muted">{{ page_description }}</p>
        </div>
        <div>
            <a href="{% url 'item-create' %}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                New Item
            </a>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-funnel"></i> Filters
        </h5>
        {% if request.GET %}
        <a href="{{ request.path }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Clear All Filters
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-6 col-lg-4">
                <label for="id_q" class="form-label">Search</label>
                {{ filter.form.q }}
            </div>
            <div class="col-md-6 col-lg-4">
                <label for="id_project" class="form-label">Project</label>
                {{ filter.form.project }}
            </div>
            <div class="col-md-6 col-lg-4">
                <label for="id_type" class="form-label">Type</label>
                {{ filter.form.type }}
            </div>
            <div class="col-md-6 col-lg-4">
                <label for="id_organisation" class="form-label">Organisation</label>
                {{ filter.form.organisation }}
            </div>
            <div class="col-md-6 col-lg-4">
                <label for="id_requester" class="form-label">Requester</label>
                {{ filter.form.requester }}
            </div>
            <div class="col-md-6 col-lg-4">
                <label for="id_assigned_to" class="form-label">Assigned To</label>
                {{ filter.form.assigned_to }}
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg"></i> Apply Filters
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Active Filters Display -->
{% if request.GET %}
<div class="mb-3">
    <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="badge bg-secondary">Active Filters:</span>
        {% if filter.form.q.value %}
        <span class="badge bg-info">
            Search: "{{ filter.form.q.value }}"
            <a href="?{% for key, value in request.GET.items %}{% if key != 'q' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white text-decoration-none ms-1">×</a>
        </span>
        {% endif %}
        {% if filter.form.project.value %}
        <span class="badge bg-info">
            Project: {{ filter.form.project.value }}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'project' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white text-decoration-none ms-1">×</a>
        </span>
        {% endif %}
        {% if filter.form.type.value %}
        <span class="badge bg-info">
            Type: {{ filter.form.type.value }}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'type' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white text-decoration-none ms-1">×</a>
        </span>
        {% endif %}
        {% if filter.form.organisation.value %}
        <span class="badge bg-info">
            Organisation: {{ filter.form.organisation.value }}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'organisation' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white text-decoration-none ms-1">×</a>
        </span>
        {% endif %}
        {% if filter.form.requester.value %}
        <span class="badge bg-info">
            Requester: {{ filter.form.requester.value }}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'requester' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white text-decoration-none ms-1">×</a>
        </span>
        {% endif %}
        {% if filter.form.assigned_to.value %}
        <span class="badge bg-info">
            Assigned To: {{ filter.form.assigned_to.value }}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'assigned_to' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" class="text-white text-decoration-none ms-1">×</a>
        </span>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Results Count -->
<div class="mb-2">
    <p class="text-muted">
        Showing {{ table.page.start_index }} - {{ table.page.end_index }} of {{ table.paginator.count }} items
    </p>
</div>

<!-- List Container for HTMX refresh -->
<div id="items-list-container">
    <!-- Table -->
    <div class="table-responsive">
        {% render_table table %}
    </div>
    
    <!-- Empty state message (if no results) -->
    {% if not table.rows %}
    <div class="text-center text-muted py-5">
        <div class="mb-3">
            <i class="bi bi-inbox" style="font-size: 4rem;"></i>
        </div>
        <h5>No items found</h5>
        {% if request.GET %}
        <p>Try adjusting your search filters</p>
        {% else %}
        <p>No items in this status yet</p>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}
