{% extends "embed/base.html" %}
{% load agira_filters %}

{% block title %}Releases - {{ project.name }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2 class="h4">Releases</h2>
        <p class="text-muted">Software releases for {{ project.name }}</p>
    </div>
    <div class="col-auto">
        <a href="{% url 'embed-project-issues' project.id %}?token={{ token }}" class="btn btn-outline-secondary">
            <i class="bi bi-list-ul"></i> Back to Issues
        </a>
    </div>
</div>

{% if releases_with_items %}
<!-- Accordion for releases -->
<div class="accordion" id="releasesAccordion">
    {% for release_data in releases_with_items %}
    {% with release=release_data.release items=release_data.items %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ release.id }}">
            <button class="accordion-button collapsed" type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#collapse{{ release.id }}" 
                    aria-expanded="false" 
                    aria-controls="collapse{{ release.id }}">
                <div class="d-flex w-100 align-items-center">
                    <div class="flex-grow-1">
                        <strong>{{ release.name }}</strong>
                        <span class="badge bg-primary ms-2">v{{ release.version }}</span>
                        {% if release.update_date %}
                        <span class="text-muted ms-2 small">
                            <i class="bi bi-calendar"></i> {{ release.update_date|date:"d.m.Y" }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-end me-3">
                        <span class="badge bg-secondary">{{ items|length }} item{{ items|length|pluralize }}</span>
                    </div>
                </div>
            </button>
        </h2>
        <div id="collapse{{ release.id }}" 
             class="accordion-collapse collapse" 
             aria-labelledby="heading{{ release.id }}" 
             data-bs-parent="#releasesAccordion">
            <div class="accordion-body">
                {% if items %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th style="width: 60px;">ID</th>
                                <th>Title</th>
                                <th style="width: 100px;">Type</th>
                                <th style="width: 120px;">Status</th>
                                <th style="width: 140px;">Updated</th>
                                <th class="text-center" style="width: 80px;">Solution</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td>
                                    <a href="{% url 'embed-issue-detail' item.id %}?token={{ token }}" class="text-decoration-none">
                                        {{ item.id }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'embed-issue-detail' item.id %}?token={{ token }}" class="text-decoration-none">
                                        {{ item.title }}
                                    </a>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ item.type.name }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ item.get_status_display }}</span>
                                </td>
                                <td class="text-muted small">
                                    {{ item.updated_at|date:"d.m.Y H:i" }}
                                </td>
                                <td class="text-center">
                                    {% if item.solution_description|trim %}
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#solutionModal{{ item.id }}"
                                            title="View Solution Description"
                                            aria-label="View solution description for issue {{ item.id }}">
                                        <i class="bi bi-lightbulb"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> No items associated with this release.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endwith %}
    {% endfor %}
</div>

<!-- Solution Description Modals -->
{% for release_data in releases_with_items %}
{% for item in release_data.items %}
{% if item.solution_description|trim %}
<div class="modal fade" id="solutionModal{{ item.id }}" tabindex="-1" aria-labelledby="solutionModalLabel{{ item.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="solutionModalLabel{{ item.id }}">Solution Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <strong>Issue #{{ item.id }}:</strong> {{ item.title }}
                </div>
                <div class="mb-2">
                    <strong>Release:</strong> {{ item.solution_release.name }} (v{{ item.solution_release.version }})
                </div>
                <hr>
                <div class="solution-content">
                    {{ item.solution_description|render_markdown }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endfor %}

{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No releases found for this project.
</div>
{% endif %}

{% endblock %}
