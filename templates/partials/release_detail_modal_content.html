{% load django_tables2 %}

<!-- Release Detail Modal Header -->
<div class="modal-header bg-light">
    <div class="w-100">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h5 class="modal-title">
                    <i class="bi bi-box-seam"></i> {{ release.name }}
                    <span class="badge bg-secondary ms-2">{{ release.version }}</span>
                </h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <!-- Release Details -->
        <div class="mt-3">
            <div class="row">
                <div class="col-md-3">
                    <small class="text-muted">Status</small><br>
                    {% if release.status == 'Planned' %}
                    <span class="badge bg-info">{{ release.status }}</span>
                    {% elif release.status == 'Working' %}
                    <span class="badge bg-primary">{{ release.status }}</span>
                    {% elif release.status == 'Closed' %}
                    <span class="badge bg-success">{{ release.status }}</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ release.status }}</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Type</small><br>
                    {% if release.type %}
                    <span class="badge bg-secondary">{{ release.type }}</span>
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Planned Date</small><br>
                    {% if release.planned_date %}
                    <strong>{{ release.planned_date|date:"Y-m-d" }}</strong>
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <small class="text-muted">Updated</small><br>
                    {% if release.updated_at %}
                    {{ release.updated_at|date:"Y-m-d H:i" }}
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Change Link/Button -->
            <div class="mt-3">
                {% if primary_change %}
                <a href="{% url 'change-detail' primary_change.id %}" class="btn btn-sm btn-success me-2">
                    <i class="bi bi-arrow-right-circle"></i> View Related Change
                </a>
                {% else %}
                <button type="button" 
                        class="btn btn-sm btn-primary"
                        hx-post="{% url 'release-create-change' release.id %}"
                        hx-swap="none"
                        hx-on::after-request="handleCreateChangeResponse(event)">
                    <i class="bi bi-plus-circle"></i> Create Change
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Release Items Table -->
<div class="modal-body" style="min-height: 400px; max-height: 600px; overflow-y: auto;">
    <div class="mb-3">
        <h6>Items in this Release <span class="badge bg-secondary">{{ items_count }}</span></h6>
    </div>
    
    <!-- Filters -->
    <div class="mb-3">
        <form method="get" id="releaseItemsFilterForm">
            <div class="row g-2">
                <div class="col-md-4">
                    {{ filter.form.q }}
                </div>
                <div class="col-md-2">
                    {{ filter.form.type }}
                </div>
                <div class="col-md-3">
                    {{ filter.form.status }}
                </div>
                <div class="col-md-3">
                    {{ filter.form.assigned_to }}
                </div>
            </div>
        </form>
    </div>
    
    <!-- Items Table -->
    {% if table.rows %}
        {% render_table table %}
    {% else %}
        <div class="alert alert-info">
            No items found for this release{% if filter.form.q.value %} matching your filters{% endif %}.
        </div>
    {% endif %}
</div>

<script>
// Auto-submit filter form on change
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('releaseItemsFilterForm');
    if (filterForm) {
        filterForm.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('change', function() {
                // Update the modal content with filtered results
                const formData = new FormData(filterForm);
                const params = new URLSearchParams(formData);
                const currentUrl = window.location.pathname;
                htmx.ajax('GET', `${currentUrl}?${params.toString()}`, {
                    target: '#releaseDetailModalContent',
                    swap: 'innerHTML'
                });
            });
        });
    }
});
</script>
