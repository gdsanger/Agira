{% extends "base.html" %}

{% block title %}{% if item %}Edit {{ item.title }}{% else %}New Item{% endif %} - Agira{% endblock %}

{% block extra_head %}
<!-- ToastUI Editor CSS -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<style>
/* Prevent Toast Editor from growing infinitely */
#description-editor,
#user-input-editor,
#solution-editor {
    max-height: 400px;
    overflow: hidden;
}

#description-editor .toastui-editor-defaultUI,
#user-input-editor .toastui-editor-defaultUI,
#solution-editor .toastui-editor-defaultUI {
    max-height: 400px !important;
    overflow: hidden !important;
}

#description-editor .toastui-editor-md-container,
#user-input-editor .toastui-editor-md-container,
#solution-editor .toastui-editor-md-container,
#description-editor .toastui-editor-preview,
#user-input-editor .toastui-editor-preview,
#solution-editor .toastui-editor-preview {
    overflow-x: auto !important;
    overflow-y: auto !important;
    max-height: 350px !important;
    word-wrap: break-word;
    word-break: break-word;
}

/* Ensure the editor wraps long lines and allows horizontal scrolling if needed */
#description-editor .toastui-editor-contents,
#user-input-editor .toastui-editor-contents,
#solution-editor .toastui-editor-contents {
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
}

#description-editor .toastui-editor-contents pre,
#user-input-editor .toastui-editor-contents pre,
#solution-editor .toastui-editor-contents pre {
    overflow-x: auto;
    white-space: pre;
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header with Toolbar -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h3>{% if item %}{{ item.title }}{% else %}Create New Item{% endif %}</h3>
            <p class="text-muted">
                {% if item %}
                    <a href="{% url 'project-detail' item.project.id %}" class="text-decoration-none">{{ item.project.name }}</a> • {{ item.type.name }}
                {% else %}
                    Add a new item to Agira
                {% endif %}
            </p>
        </div>
        {% if item %}
       
        <div class="btn-group">
             <a href="{% url 'project-detail' item.project.id %}" class="btn btn-outline-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Back to Project
            </a>
            <button type="submit" form="itemForm" class="btn btn-outline-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg me-1" viewBox="0 0 16 16">
                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                </svg>
                Update
            </button>
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#moveItemModal">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left-right" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/>
                </svg>
                Move
            </button>
              <a href="{% url 'item-detail' item.id %}" class="btn btn-outline-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg me-1" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                </svg>
                Cancel
            </a>
               <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                Delete
            </button>
             <!-- Weaviate Status Button -->
            <div
                hx-get="{% url 'weaviate-status' 'item' item.id %}"
                hx-trigger="load"
                hx-swap="innerHTML">
                <!-- Button will be loaded via HTMX -->
            </div>
        </div>
           

       
        {% endif %}
    </div>
</div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        {% if item %}
        <li class="breadcrumb-item"><a href="{% url 'project-detail' item.project.id %}">{{ item.project.name }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'item-detail' item.id %}">{{ item.title }}</a></li>
        <li class="breadcrumb-item active">Edit</li>
        {% else %}
        <li class="breadcrumb-item active">New Item</li>
        {% endif %}
    </ol>
</nav>

<!-- Form Container with 2-Column Layout -->
<div class="detail-layout">
    <!-- Left Column: Main Content -->
    <div class="detail-main">
        <form id="itemForm" 
              hx-post="{% if item %}{% url 'item-update' item.id %}{% else %}{% url 'item-create' %}{% endif %}"
              hx-swap="none"
              hx-on::after-request="handleFormResponse(event)">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="title" 
                                   name="title" 
                                   value="{% if item %}{{ item.title }}{% endif %}"
                                   maxlength="500">
                            <button type="button" class="btn btn-outline-secondary" id="ai-title-btn" title="Generate title from description using AI">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5 2V0H3v2H1v2h2v2h2V4h2V2H5zm6 9V9H9v2H7v2h2v2h2v-2h2v-2h-2zm1.5-6.5v-2h-3v2h-2v3h2v2h3v-2h2v-3h-2z"/>
                                    <path d="M4.5 11.5v-1h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5zm-1-4v-1a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    

                </div>
            </div>
            
            <!-- Content Tabs for Edit Mode -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Content</h5>
                </div>
                <div class="card-body">
                    <!-- Content Tabs -->
                    <ul class="nav nav-tabs mb-3" id="editContentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button 
                                class="nav-link active" 
                                id="edit-description-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#edit-description" 
                                type="button" 
                                role="tab"
                                onclick="saveActiveDetailTab('{% if item %}{{ item.id }}{% else %}new{% endif %}', 'description')">
                                Description
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button 
                                class="nav-link" 
                                id="edit-user-input-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#edit-user-input" 
                                type="button" 
                                role="tab"
                                onclick="saveActiveDetailTab('{% if item %}{{ item.id }}{% else %}new{% endif %}', 'user-input')">
                                Original Mail Text
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button 
                                class="nav-link" 
                                id="edit-solution-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#edit-solution" 
                                type="button" 
                                role="tab"
                                onclick="saveActiveDetailTab('{% if item %}{{ item.id }}{% else %}new{% endif %}', 'solution')">
                                Solution
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content" id="editContentTabContent">
                        <!-- Description Tab -->
                        <div class="tab-pane fade show active" id="edit-description" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Description</h6>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="ai-optimize-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                                        <path d="M5 2V0H3v2H1v2h2v2h2V4h2V2H5zm6 9V9H9v2H7v2h2v2h2v-2h2v-2h-2zm1.5-6.5v-2h-3v2h-2v3h2v2h3v-2h2v-3h-2z"/>
                                        <path d="M4.5 11.5v-1h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5zm-1-4v-1a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                                    </svg>
                                    Optimize Text
                                </button>
                            </div>
                            <div id="description-editor"></div>
                            <input type="hidden" id="description" name="description">
                        </div>
                        
                        <!-- Original Mail Text Tab -->
                        <div class="tab-pane fade" id="edit-user-input" role="tabpanel">
                            <h6 class="mb-3">Original Mail Text (unverändert)</h6>
                            <small class="text-muted d-block mb-3">Enthält den ursprünglichen Nachrichtentext der eingegangenen E-Mail. Dieses Feld wird nicht automatisch durch KI verändert.</small>
                            <div id="user-input-editor"></div>
                            <input type="hidden" id="user_input" name="user_input">
                        </div>
                        
                        <!-- Solution Tab -->
                        <div class="tab-pane fade" id="edit-solution" role="tabpanel">
                            <h6 class="mb-3">Solution Description</h6>
                            <div id="solution-editor"></div>
                            <input type="hidden" id="solution_description" name="solution_description">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    {% if item %}Update Item{% else %}Create Item{% endif %}
                </button>
                <a href="{% if item %}{% url 'item-detail' item.id %}{% else %}{% url 'dashboard' %}{% endif %}" 
                   class="btn btn-secondary">
                    Cancel
                </a>
            </div>
        </form>
    </div>
    
    <!-- Right Column: Sidebar -->
    <div class="detail-sidebar">
        <!-- Additional Information Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Additional Information</h5>
            </div>
            <div class="card-body">
                <!-- Status -->
                <div class="mb-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status" form="itemForm">
                        {% for status_value, status_label in statuses %}
                        <option value="{{ status_value }}" 
                                {% if item and item.status == status_value %}selected{% endif %}
                                {% if not item and status_value == 'Inbox' %}selected{% endif %}>
                            {{ status_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Organisation -->
                <div class="mb-3">
                    <label for="organisation" class="form-label">Organisation</label>
                    <select class="form-select" id="organisation" name="organisation" form="itemForm">
                        <option value="">None</option>
                        {% for org in organisations %}
                        <option value="{{ org.id }}" 
                                {% if item and item.organisation and item.organisation.id == org.id or not item and default_organisation and default_organisation.id == org.id %}selected{% endif %}>
                            {{ org.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Requester -->
                <div class="mb-3">
                    <label for="requester" class="form-label">Requester</label>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="requester" name="requester" form="itemForm">
                            <option value="">None</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" 
                                    {% if item and item.requester and item.requester.id == user.id or not item and default_requester and default_requester.id == user.id %}selected{% endif %}>
                                {{ user.name }}
                                {% with org_short=user.get_primary_org_short %}
                                    {% if org_short %} ({{ org_short }}){% else %} (N/A){% endif %}
                                {% endwith %}
                            </option>
                            {% endfor %}
                        </select>
                        {% if item %}
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickCreateUserModal" title="Quick Create User">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Assigned To -->
                <div class="mb-3">
                    <label for="assigned_to" class="form-label">Assigned To</label>
                    <select class="form-select" id="assigned_to" name="assigned_to" form="itemForm">
                        <option value="">None</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" 
                                {% if item and item.assigned_to and item.assigned_to.id == user.id %}selected{% endif %}>
                            {{ user.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Followers -->
                <div class="mb-3">
                    <label for="follower-select-form" class="form-label">Followers</label>
                    <div id="followers-display-form" class="mb-2">
                        {% if item %}
                            {% with item_followers=item.get_followers %}
                                {% if item_followers %}
                                    <div class="d-flex flex-wrap gap-1 mb-2">
                                        {% for follower in item_followers %}
                                            <span class="badge bg-secondary follower-badge-form" data-user-id="{{ follower.id }}">
                                                {{ follower.name|default:follower.username }}
                                                <button type="button" class="btn-close btn-close-white ms-1 remove-follower-btn-form" style="font-size: 0.6rem; padding: 0.1rem;" data-user-id="{{ follower.id }}" aria-label="Remove"></button>
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                    <select class="form-select form-select-sm" id="follower-select-form">
                        <option value="">+ Add Follower...</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" data-name="{{ user.name|default:user.username }}">{{ user.name|default:user.username }} ({{ user.email }})</option>
                        {% endfor %}
                    </select>
                    <!-- Hidden inputs for follower IDs -->
                    <div id="follower-ids-container"></div>
                </div>
                
                <!-- Project -->
                <div class="mb-3">
                    <label for="project" class="form-label">Project <span class="text-danger">*</span></label>
                    <select class="form-select" id="project" name="project" form="itemForm" required>
                        <option value="">Select project...</option>
                        {% for proj in projects %}
                        <option value="{{ proj.id }}" 
                                {% if item and item.project.id == proj.id %}selected
                                {% elif not item and default_project and default_project.id == proj.id %}selected
                                {% endif %}>
                            {{ proj.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Type -->
                <div class="mb-3">
                    <label for="type" class="form-label">Type <span class="text-danger">*</span></label>
                    <select class="form-select" id="type" name="type" form="itemForm" required>
                        <option value="">Select type...</option>
                        {% for item_type in item_types %}
                        <option value="{{ item_type.id }}" 
                                {% if item and item.type.id == item_type.id %}selected{% endif %}>
                            {{ item_type.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Blueprint (only for new items) -->
                {% if not item %}
                <div class="mb-3">
                    <label for="blueprint" class="form-label">Apply Blueprint (optional)</label>
                    <select class="form-select" id="blueprint" name="blueprint" form="itemForm">
                        <option value="">None</option>
                        {% for bp in blueprints %}
                        <option value="{{ bp.id }}" 
                                data-title="{{ bp.title|escapejs }}"
                                data-description="{{ bp.description_md|escapejs }}">
                            {{ bp.title }} ({{ bp.category.name }})
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Select a blueprint to pre-fill title and description</small>
                </div>
                
                <!-- Blueprint Variables Container -->
                <div id="blueprint-variables-container"></div>
                {% endif %}
                
                <!-- Parent Item -->
                <div class="mb-3">
                    <label for="parent" class="form-label">Parent Item</label>
                    <select class="form-select" id="parent" name="parent" form="itemForm">
                        <option value="">None</option>
                        {% if item %}
                            {% for parent_item in parent_items %}
                            <option value="{{ parent_item.id }}" 
                                    {% if item.parent and item.parent.id == parent_item.id %}selected{% endif %}>
                                {{ parent_item.title }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                
                <!-- Solution Release -->
                <div class="mb-3">
                    <label for="solution_release" class="form-label">Solution Release</label>
                    {% if item %}
                    <select class="form-select" id="solution_release" name="solution_release" form="itemForm">
                        <option value="">None</option>
                        {% for release in releases %}
                        <option value="{{ release.id }}" 
                                {% if item.solution_release and item.solution_release.id == release.id %}selected{% endif %}>
                            {{ release.version }} - {{ release.name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <select class="form-select" id="solution_release" name="solution_release" form="itemForm" disabled>
                        <option value="">None</option>
                    </select>
                    <small class="text-muted d-block">Available after creating the item</small>
                    {% endif %}
                </div>
                
                <!-- Node -->
                <div class="mb-0">
                    <label for="node" class="form-label">Node</label>
                    {% if nodes %}
                    <select class="form-select" id="node" name="node" form="itemForm">
                        <option value="">None</option>
                        {% for node in nodes %}
                        <option value="{{ node.id }}" 
                                {% if item and item.nodes.first and item.nodes.first.id == node.id %}selected{% endif %}>
                            {{ node.name }} ({{ node.type }})
                        </option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <select class="form-select" id="node" name="node" form="itemForm" disabled>
                        <option value="">None</option>
                    </select>
                    <small class="text-muted d-block">{% if not item %}Select a project first{% else %}No nodes available for this project{% endif %}</small>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Help Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Help</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small text-muted mb-0">
                    <li class="mb-2">• Use Markdown for rich formatting in descriptions</li>
                    <li class="mb-2">• Required fields are marked with *</li>
                    <li>• All fields can be updated later</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ToastUI Editor JS -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
// Initialize ToastUI Editor for Description
const descriptionEditor = new toastui.Editor({
    el: document.querySelector('#description-editor'),
    height: '400px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    {% if item and item.description %}
    initialValue: '{{ item.description|escapejs }}',
    {% else %}
    initialValue: '',
    {% endif %}
    theme: 'dark',
    usageStatistics: false
});

// Force editor to respect height constraints and enable proper scrolling
document.querySelector('#description-editor .toastui-editor-defaultUI').style.maxHeight = '400px';
document.querySelector('#description-editor .toastui-editor-defaultUI').style.overflow = 'hidden';

// Initialize ToastUI Editor for User Input (Original Mail Text)
const userInputEditor = new toastui.Editor({
    el: document.querySelector('#user-input-editor'),
    height: '400px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    {% if item and item.user_input %}
    initialValue: '{{ item.user_input|escapejs }}',
    {% else %}
    initialValue: '',
    {% endif %}
    theme: 'dark',
    usageStatistics: false
});

// Force editor to respect height constraints and enable proper scrolling
document.querySelector('#user-input-editor .toastui-editor-defaultUI').style.maxHeight = '400px';
document.querySelector('#user-input-editor .toastui-editor-defaultUI').style.overflow = 'hidden';

// Initialize ToastUI Editor for Solution Description
const solutionEditor = new toastui.Editor({
    el: document.querySelector('#solution-editor'),
    height: '400px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    {% if item and item.solution_description %}
    initialValue: '{{ item.solution_description|escapejs }}',
    {% else %}
    initialValue: '',
    {% endif %}
    theme: 'dark',
    usageStatistics: false
});

// Force editor to respect height constraints and enable proper scrolling
document.querySelector('#solution-editor .toastui-editor-defaultUI').style.maxHeight = '400px';
document.querySelector('#solution-editor .toastui-editor-defaultUI').style.overflow = 'hidden';

// Workaround for Toast UI Editor RangeError in code blocks with paste/Enter
// This fixes the issue where pasted content in code blocks causes RangeError exceptions
// Reference: https://github.com/nhn/tui.editor/issues/1349
function setupEditorWorkaround(editor) {
    let isProcessing = false;
    
    editor.on('change', function() {
        if (isProcessing) return;
        
        try {
            isProcessing = true;
            const mdtext = editor.getMarkdown();
            
            // Clean up problematic HTML tags that may appear after paste
            const cleanedMdText = mdtext
                .replace(/<\/?span[^>]*>/g, '')  // Remove span tags
                .replace(/<br[\s/]*>/g, '')      // Remove <br>
                .replace(/<\/?u>/g, '')          // Remove underline tags
                .replace(/<\/?strong>/g, '**')   // Convert strong to markdown
                .replace(/<\/?em>/g, '_');       // Convert em to markdown
            
            if (cleanedMdText !== mdtext) {
                editor.setMarkdown(cleanedMdText, false);
            }
        } catch (e) {
            // Silently catch errors to prevent disrupting user experience
            console.warn('Editor cleanup warning:', e);
        } finally {
            isProcessing = false;
        }
    });
}

// Apply workaround to all editors
setupEditorWorkaround(descriptionEditor);
setupEditorWorkaround(userInputEditor);
setupEditorWorkaround(solutionEditor);

// Function to sync editor content to hidden fields
function syncEditorContent() {
    document.getElementById('description').value = descriptionEditor.getMarkdown();
    document.getElementById('user_input').value = userInputEditor.getMarkdown();
    document.getElementById('solution_description').value = solutionEditor.getMarkdown();
    
    // Add blueprint variables to form if any
    {% if not item %}
    const variableInputs = document.querySelectorAll('[id^="blueprint_var_"]');
    const variables = {};
    variableInputs.forEach(input => {
        const varName = input.id.replace('blueprint_var_', '');
        variables[varName] = input.value;
    });
    if (Object.keys(variables).length > 0) {
        // Remove any existing blueprint_variables input
        const existingInput = document.querySelector('input[name="blueprint_variables"]');
        if (existingInput) {
            existingInput.remove();
        }
        // Add new blueprint variables input
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'blueprint_variables';
        hiddenInput.value = JSON.stringify(variables);
        document.getElementById('itemForm').appendChild(hiddenInput);
    }
    {% endif %}
}

// Sync editor content to hidden fields on form submit (for non-HTMX submissions)
document.getElementById('itemForm').addEventListener('submit', function() {
    syncEditorContent();
});

// Sync editor content to hidden fields before HTMX request
document.getElementById('itemForm').addEventListener('htmx:configRequest', function() {
    syncEditorContent();
});

{% if not item %}
// Blueprint selection handler (only for new items)
let currentBlueprintVariables = [];

document.getElementById('blueprint').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const variablesContainer = document.getElementById('blueprint-variables-container');
    
    // Clear previous variables
    variablesContainer.innerHTML = '';
    currentBlueprintVariables = [];
    
    if (selectedOption.value) {
        const blueprintTitle = selectedOption.getAttribute('data-title');
        const blueprintDescription = selectedOption.getAttribute('data-description');
        
        // Extract variables from both title and description
        const variablePattern = /\{\{\s*([a-zA-Z0-9_-]+)\s*\}\}/g;
        const seenVars = new Set();
        let match;
        
        // Extract from title
        if (blueprintTitle) {
            while ((match = variablePattern.exec(blueprintTitle)) !== null) {
                const varName = match[1];
                if (!seenVars.has(varName)) {
                    seenVars.add(varName);
                    currentBlueprintVariables.push(varName);
                }
            }
            // Reset lastIndex for reuse of the same pattern
            variablePattern.lastIndex = 0;
        }
        
        // Extract from description
        if (blueprintDescription) {
            while ((match = variablePattern.exec(blueprintDescription)) !== null) {
                const varName = match[1];
                if (!seenVars.has(varName)) {
                    seenVars.add(varName);
                    currentBlueprintVariables.push(varName);
                }
            }
        }
        
        // Show variable inputs if any found
        if (currentBlueprintVariables.length > 0) {
                const header = document.createElement('div');
                header.className = 'mb-3';
                header.innerHTML = '<h6 class="mb-2">Blueprint Variables</h6><div class="alert alert-info small"><i class="bi bi-info-circle"></i> The blueprint contains variables. Please provide values below.</div>';
                variablesContainer.appendChild(header);
                
                currentBlueprintVariables.forEach(varName => {
                    const div = document.createElement('div');
                    div.className = 'mb-3';
                    
                    const label = document.createElement('label');
                    label.className = 'form-label';
                    label.htmlFor = `blueprint_var_${varName}`;
                    label.innerHTML = `${varName} <span class="text-danger">*</span>`;
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.id = `blueprint_var_${varName}`;
                    input.name = `blueprint_var_${varName}`;
                    input.required = true;
                    input.placeholder = `Enter value for ${varName}`;
                    input.setAttribute('form', 'itemForm');
                    
                    div.appendChild(label);
                    div.appendChild(input);
                    variablesContainer.appendChild(div);
                });
            }
        }
});
{% endif %}

// AI Title Generation Button
document.getElementById('ai-title-btn').addEventListener('click', async function() {
    const btn = this;
    const descriptionText = descriptionEditor.getMarkdown();
    
    if (!descriptionText || descriptionText.trim() === '') {
        showToast('error', 'Please enter a description first');
        return;
    }
    
    // Disable button and show loading state
    btn.disabled = true;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
        const response = await fetch('{% url "ai-generate-title" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ text: descriptionText })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            document.getElementById('title').value = data.title;
            showToast('success', 'Title generated successfully');
        } else {
            showToast('error', data.error || 'Failed to generate title');
        }
    } catch (error) {
        showToast('error', 'Failed to generate title');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// AI Text Optimization Button
document.getElementById('ai-optimize-btn').addEventListener('click', async function() {
    const btn = this;
    const descriptionText = descriptionEditor.getMarkdown();
    
    if (!descriptionText || descriptionText.trim() === '') {
        showToast('error', 'Please enter a description first');
        return;
    }
    
    // Disable button and show loading state
    btn.disabled = true;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Optimizing...';
    
    try {
        const response = await fetch('{% url "ai-optimize-text" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ text: descriptionText })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            descriptionEditor.setMarkdown(data.text);
            showToast('success', 'Text optimized successfully');
        } else {
            showToast('error', data.error || 'Failed to optimize text');
        }
    } catch (error) {
        showToast('error', 'Failed to optimize text');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// Handle form response
function handleFormResponse(event) {
    const xhr = event.detail.xhr;
    
    if (xhr.status === 200 || xhr.status === 201) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                // Check if mail preview exists
                if (response.mail_preview) {
                    // Show mail confirmation modal
                    showMailConfirmationModal(response.mail_preview, response.item_id, response.redirect);
                } else {
                    // No mail to send, just show success and redirect
                    showToast('success', response.message || 'Item saved successfully');
                    
                    // Redirect after a short delay
                    setTimeout(() => {
                        if (response.redirect) {
                            window.location.href = response.redirect;
                        } else if (response.item_id) {
                            window.location.href = `/items/${response.item_id}/`;
                        }
                    }, 1000);
                }
            } else {
                showToast('error', response.error || 'Failed to save item');
            }
        } catch (e) {
            showToast('error', 'An unexpected error occurred');
        }
    } else {
        try {
            const response = JSON.parse(xhr.responseText);
            showToast('error', response.error || 'Failed to save item');
        } catch (e) {
            showToast('error', 'Failed to save item');
        }
    }
}

// Show mail confirmation modal
let mailModalEventListenerAdded = false;

function showMailConfirmationModal(mailPreview, itemId, redirectUrl) {
    // Populate modal with mail preview data
    document.getElementById('mail-subject-preview').textContent = mailPreview.subject;
    
    // Sanitize and set message HTML (bleach should have sanitized on server, but double-check)
    const messagePreview = document.getElementById('mail-message-preview');
    messagePreview.innerHTML = mailPreview.message;  // Already sanitized by server
    
    // Set sender info
    const fromText = mailPreview.from_name 
        ? `${mailPreview.from_name} <${mailPreview.from_address || 'default'}>`
        : mailPreview.from_address || 'Standard-Absender';
    document.getElementById('mail-from-preview').textContent = fromText;
    
    // Set recipient info (try to get from item's requester)
    const toText = 'Anfragender (aus Item)';
    document.getElementById('mail-to-preview').textContent = toText;
    
    // Set CC if present
    const ccContainer = document.getElementById('mail-cc-container');
    if (mailPreview.cc_address) {
        document.getElementById('mail-cc-preview').textContent = mailPreview.cc_address;
        ccContainer.style.display = 'block';
    } else {
        ccContainer.style.display = 'none';
    }
    
    // Show the modal
    const modalEl = document.getElementById('mailConfirmationModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    
    // Handle send button
    const sendBtn = document.getElementById('confirmSendMailBtn');
    sendBtn.dataset.sent = '';  // Clear sent flag
    sendBtn.onclick = function() {
        sendStatusMail(itemId, mailPreview, redirectUrl, modal);
    };
    
    // Handle cancel - redirect when modal closes (only add once)
    if (!mailModalEventListenerAdded) {
        modalEl.addEventListener('hidden.bs.modal', function(e) {
            // Only redirect if modal is closed without sending
            if (!sendBtn.dataset.sent) {
                showToast('info', 'Item gespeichert - Mail nicht versendet');
                setTimeout(() => {
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    } else if (itemId) {
                        window.location.href = `/items/${itemId}/`;
                    }
                }, 1000);
            }
        });
        mailModalEventListenerAdded = true;
    }
}

// Send status mail
function sendStatusMail(itemId, mailPreview, redirectUrl, modal) {
    const sendBtn = document.getElementById('confirmSendMailBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Wird gesendet...';
    
    fetch(`/items/${itemId}/send-status-mail/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            subject: mailPreview.subject,
            message: mailPreview.message,
            to: '',  // Will use requester email from backend
            from_address: mailPreview.from_address,
            cc_address: mailPreview.cc_address
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sendBtn.dataset.sent = 'true';
            showToast('success', 'Mail erfolgreich versendet!');
            modal.hide();
            setTimeout(() => {
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                } else if (itemId) {
                    window.location.href = `/items/${itemId}/`;
                }
            }, 1000);
        } else {
            showToast('error', data.error || 'Fehler beim Mailversand');
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send me-1" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg> Mail senden';
        }
    })
    .catch(error => {
        console.error('Mail send error:', error);  // Log error for debugging
        showToast('error', 'Netzwerkfehler beim Mailversand');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send me-1" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg> Mail senden';
    });
}

// Toast notification function
function showToast(type, message) {
    const toastEl = document.getElementById(type === 'success' ? 'successToast' : 'errorToast');
    if (!toastEl) {
        // Create toast elements if they don't exist (for item form page)
        const container = document.querySelector('.toast-container') || createToastContainer();
        const toast = createToastElement(type, message);
        container.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 5000 });
        bsToast.show();
        toast.addEventListener('hidden.bs.toast', () => toast.remove());
        return;
    }
    
    const messageEl = document.getElementById(type === 'success' ? 'toastMessage' : 'errorToastMessage');
    messageEl.textContent = message;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

function createToastElement(type, message) {
    const toastEl = document.createElement('div');
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
    toastEl.className = `toast align-items-center text-white ${bgClass} border-0`;
    toastEl.setAttribute('role', 'alert');
    
    // Create structure without innerHTML to avoid XSS
    const flexDiv = document.createElement('div');
    flexDiv.className = 'd-flex';
    
    const bodyDiv = document.createElement('div');
    bodyDiv.className = 'toast-body';
    bodyDiv.textContent = message;  // Use textContent to prevent XSS
    
    const closeBtn = document.createElement('button');
    closeBtn.type = 'button';
    closeBtn.className = 'btn-close btn-close-white me-2 m-auto';
    closeBtn.setAttribute('data-bs-dismiss', 'toast');
    closeBtn.setAttribute('aria-label', 'Close');
    
    flexDiv.appendChild(bodyDiv);
    flexDiv.appendChild(closeBtn);
    toastEl.appendChild(flexDiv);
    
    return toastEl;
}

// Follower management functions for form
let currentFollowersForm = new Set();

// Initialize current followers from existing badges
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('#followers-display-form .badge[data-user-id]').forEach(badge => {
        currentFollowersForm.add(badge.dataset.userId);
        // Add hidden input for this follower
        addFollowerHiddenInput(badge.dataset.userId);
    });
    updateFollowerSelectForm();
    
    // Add event listener for follower select
    const followerSelectForm = document.getElementById('follower-select-form');
    if (followerSelectForm) {
        followerSelectForm.addEventListener('change', function() {
            if (this.value) {
                addFollowerForm(this.value);
                this.value = '';
            }
        });
    }
    
    // Add event delegation for remove buttons
    const followersDisplay = document.getElementById('followers-display-form');
    if (followersDisplay) {
        followersDisplay.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-follower-btn-form')) {
                const userId = e.target.dataset.userId;
                if (userId) {
                    removeFollowerForm(parseInt(userId));
                }
            }
        });
    }
});

function updateFollowerSelectForm() {
    const select = document.getElementById('follower-select-form');
    if (!select) return;
    
    // Update options to hide already selected followers
    Array.from(select.options).forEach(option => {
        if (option.value && currentFollowersForm.has(option.value)) {
            option.style.display = 'none';
        } else {
            option.style.display = '';
        }
    });
}

function addFollowerHiddenInput(userId) {
    const container = document.getElementById('follower-ids-container');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'follower_ids';
    input.value = userId;
    input.id = `follower-input-${userId}`;
    input.form = 'itemForm';
    container.appendChild(input);
}

function removeFollowerHiddenInput(userId) {
    const input = document.getElementById(`follower-input-${userId}`);
    if (input) {
        input.remove();
    }
}

function addFollowerForm(userId) {
    if (!userId || currentFollowersForm.has(userId)) return;
    
    const select = document.getElementById('follower-select-form');
    const option = select.querySelector(`option[value="${userId}"]`);
    if (!option) return;
    
    const userName = option.dataset.name;
    
    // Add to current followers set
    currentFollowersForm.add(userId);
    
    // Add hidden input
    addFollowerHiddenInput(userId);
    
    // Update UI
    const display = document.getElementById('followers-display-form');
    let badgesContainer = display.querySelector('.d-flex');
    
    if (!badgesContainer) {
        badgesContainer = document.createElement('div');
        badgesContainer.className = 'd-flex flex-wrap gap-1 mb-2';
        display.insertBefore(badgesContainer, display.firstChild);
    }
    
    const badge = document.createElement('span');
    badge.className = 'badge bg-secondary';
    badge.dataset.userId = userId;
    
    // Create text node for username (safe from XSS)
    const userNameText = document.createTextNode(userName + ' ');
    badge.appendChild(userNameText);
    
    // Create remove button
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn-close btn-close-white ms-1 remove-follower-btn-form';
    removeBtn.style.fontSize = '0.6rem';
    removeBtn.style.padding = '0.1rem';
    removeBtn.setAttribute('aria-label', 'Remove');
    removeBtn.dataset.userId = userId;
    badge.appendChild(removeBtn);
    
    badgesContainer.appendChild(badge);
    
    // Update select options
    updateFollowerSelectForm();
}

function removeFollowerForm(userId) {
    // Remove from current followers set
    currentFollowersForm.delete(userId.toString());
    
    // Remove hidden input
    removeFollowerHiddenInput(userId);
    
    // Update UI
    const badge = document.querySelector(`#followers-display-form .badge[data-user-id="${userId}"]`);
    if (badge) {
        badge.remove();
    }
    
    // Check if no followers left
    const display = document.getElementById('followers-display-form');
    const badgesContainer = display.querySelector('.d-flex');
    if (badgesContainer && badgesContainer.children.length === 0) {
        badgesContainer.remove();
    }
    
    // Update select options
    updateFollowerSelectForm();
}

// Detail content tab persistence for edit mode
function saveActiveDetailTab(itemId, tabName) {
    localStorage.setItem(`item:${itemId}:activeDetailTab`, tabName);
}

function loadActiveDetailTabEdit() {
    const itemId = '{% if item %}{{ item.id }}{% else %}new{% endif %}';
    const savedTab = localStorage.getItem(`item:${itemId}:activeDetailTab`);
    
    if (savedTab) {
        // Map tab names to edit mode tab IDs
        const tabMap = {
            'description': 'edit-description',
            'user-input': 'edit-user-input',
            'original-mail': 'edit-user-input',  // Map old name to new
            'solution': 'edit-solution'
        };
        
        const mappedTab = tabMap[savedTab] || savedTab;
        
        // Activate the saved tab
        const tabButton = document.getElementById(`${mappedTab}-tab`);
        const tabPane = document.getElementById(mappedTab);
        
        if (tabButton && tabPane) {
            // Remove active from default tab
            document.getElementById('edit-description-tab').classList.remove('active');
            document.getElementById('edit-description').classList.remove('show', 'active');
            
            // Activate saved tab
            tabButton.classList.add('active');
            tabPane.classList.add('show', 'active');
        }
    }
}

// Delete function for toolbar
function confirmDelete() {
    {% if item %}
    if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
        fetch('{% url 'item-delete' item.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success toast if available
                if (typeof showToast === 'function') {
                    showToast('success', data.message || 'Item deleted successfully!');
                } else {
                    alert(data.message || 'Item deleted successfully!');
                }
                setTimeout(() => {
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    }
                }, 1000);
            } else {
                if (typeof showToast === 'function') {
                    showToast('error', data.error || 'Failed to delete item');
                } else {
                    alert(data.error || 'Failed to delete item');
                }
            }
        })
        .catch(error => {
            if (typeof showToast === 'function') {
                showToast('error', 'An error occurred while deleting the item');
            } else {
                alert('An error occurred while deleting the item');
            }
        });
    }
    {% endif %}
}

// Load saved tab on page load
document.addEventListener('DOMContentLoaded', loadActiveDetailTabEdit);
</script>

<!-- Include modals -->
{% if item %}
{% include 'partials/move_item_modal.html' %}
{% endif %}
<!-- Include mail confirmation modal -->
{% include 'partials/mail_confirmation_modal.html' %}

<!-- Quick Create User Modal -->
<div class="modal fade" id="quickCreateUserModal" tabindex="-1" aria-labelledby="quickCreateUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickCreateUserModalLabel">Quick Create User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Quick Create User Modal for Edit Form -->
            <!-- Note: Form ID includes 'Edit' suffix to avoid collision with the form in item_detail.html -->
            <form id="quickCreateUserFormEdit" 
                  {% if item %}
                  data-item-id="{{ item.id }}"
                  data-create-url="{% url 'item-quick-create-user' item.id %}"
                  {% endif %}>
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quick_user_name_edit" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="quick_user_name_edit" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="quick_user_email_edit" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="quick_user_email_edit" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="quick_user_organization_edit" class="form-label">Primary Organization *</label>
                        <select class="form-select" id="quick_user_organization_edit" name="organization_id" required>
                            <option value="">Select an organization...</option>
                            {% for org in organisations %}
                            <option value="{{ org.id }}">{{ org.name }}{% if org.short %} ({{ org.short }}){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Quick Create User Handler for Edit Form
// Note: This form only exists on the edit page (when item exists),
// so the optional chaining (?.) safely handles the create page case
// Form ID includes 'Edit' suffix to avoid ID collision with item_detail.html

// Duration to display success toast before page reload
const TOAST_DISPLAY_DURATION = 800; // milliseconds

// Note: Using function expression (not arrow function) for proper 'this' binding
// Arrow functions lexically bind 'this' from enclosing scope, whereas function expressions
// receive 'this' from the event listener, which is bound to the form element.
// This allows access to form context (e.g., this.reset(), this.getAttribute())
document.getElementById('quickCreateUserFormEdit')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    // Get item ID and URL from form's data attributes (safer than template interpolation)
    const itemId = this.getAttribute('data-item-id');
    const createUrl = this.getAttribute('data-create-url');
    
    if (!itemId) {
        showToast('error', 'Cannot create user: Item not yet saved');
        return;
    }
    
    fetch(createUrl, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            
            // Close the modal if it's open
            const modalEl = document.getElementById('quickCreateUserModal');
            const modal = modalEl ? bootstrap.Modal.getInstance(modalEl) : null;
            if (modal) {
                modal.hide();
            }
            
            // Reset form
            this.reset();
            
            // Page reload approach: Simple but discards unsaved form changes
            // Trade-off: Ensures all data (including org short codes) is fresh from database
            // Alternative would be dynamic dropdown update, but adds complexity
            // Note: In edit mode, item already exists, so risk of data loss is limited
            setTimeout(() => {
                window.location.reload();
            }, TOAST_DISPLAY_DURATION);
        } else {
            showToast('error', data.error || 'Failed to create user');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Network error while creating user');
    });
});
</script>

{% endblock %}
