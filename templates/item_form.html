{% extends "base.html" %}

{% block title %}{% if item %}Edit {{ item.title }}{% else %}New Item{% endif %} - Agira{% endblock %}

{% block extra_head %}
<!-- ToastUI Editor CSS -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<style>
/* Prevent Toast Editor from growing infinitely */
#description-editor,
#solution-editor {
    max-height: 400px;
    overflow: hidden;
}

#description-editor .toastui-editor-defaultUI,
#solution-editor .toastui-editor-defaultUI {
    max-height: 400px !important;
    overflow: hidden !important;
}

#description-editor .toastui-editor-md-container,
#solution-editor .toastui-editor-md-container,
#description-editor .toastui-editor-preview,
#solution-editor .toastui-editor-preview {
    overflow-x: auto !important;
    overflow-y: auto !important;
    max-height: 350px !important;
    word-wrap: break-word;
    word-break: break-word;
}

/* Ensure the editor wraps long lines and allows horizontal scrolling if needed */
#description-editor .toastui-editor-contents,
#solution-editor .toastui-editor-contents {
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
}

#description-editor .toastui-editor-contents pre,
#solution-editor .toastui-editor-contents pre {
    overflow-x: auto;
    white-space: pre;
}
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        {% if item %}
        <li class="breadcrumb-item"><a href="{% url 'project-detail' item.project.id %}">{{ item.project.name }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'item-detail' item.id %}">{{ item.title }}</a></li>
        <li class="breadcrumb-item active">Edit</li>
        {% else %}
        <li class="breadcrumb-item active">New Item</li>
        {% endif %}
    </ol>
</nav>

<!-- Page Header -->
<div class="page-header">
    <h1>{% if item %}Edit Item{% else %}Create New Item{% endif %}</h1>
    <p class="text-muted">{% if item %}Update item details{% else %}Add a new item to Agira{% endif %}</p>
</div>

<!-- Form Container with 2-Column Layout -->
<div class="detail-layout">
    <!-- Left Column: Main Content -->
    <div class="detail-main">
        <form id="itemForm" 
              hx-post="{% if item %}{% url 'item-update' item.id %}{% else %}{% url 'item-create' %}{% endif %}"
              hx-swap="none"
              hx-on::after-request="handleFormResponse(event)">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="title" 
                                   name="title" 
                                   value="{% if item %}{{ item.title }}{% endif %}"
                                   maxlength="500">
                            <button type="button" class="btn btn-outline-secondary" id="ai-title-btn" title="Generate title from description using AI">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5 2V0H3v2H1v2h2v2h2V4h2V2H5zm6 9V9H9v2H7v2h2v2h2v-2h2v-2h-2zm1.5-6.5v-2h-3v2h-2v3h2v2h3v-2h2v-3h-2z"/>
                                    <path d="M4.5 11.5v-1h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5zm-1-4v-1a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    

                </div>
            </div>
            
            <!-- Description with Markdown Editor -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Description</h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="ai-optimize-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                            <path d="M5 2V0H3v2H1v2h2v2h2V4h2V2H5zm6 9V9H9v2H7v2h2v2h2v-2h2v-2h-2zm1.5-6.5v-2h-3v2h-2v3h2v2h3v-2h2v-3h-2z"/>
                            <path d="M4.5 11.5v-1h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5zm-1-4v-1a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                        Optimize Text
                    </button>
                </div>
                <div class="card-body">
                    <div id="description-editor"></div>
                    <input type="hidden" id="description" name="description">
                </div>
            </div>
            
            <!-- Solution Description with Markdown Editor -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Solution Description</h5>
                </div>
                <div class="card-body">
                    <div id="solution-editor"></div>
                    <input type="hidden" id="solution_description" name="solution_description">
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    {% if item %}Update Item{% else %}Create Item{% endif %}
                </button>
                <a href="{% if item %}{% url 'item-detail' item.id %}{% else %}{% url 'dashboard' %}{% endif %}" 
                   class="btn btn-secondary">
                    Cancel
                </a>
            </div>
        </form>
    </div>
    
    <!-- Right Column: Sidebar -->
    <div class="detail-sidebar">
        <!-- Additional Information Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Additional Information</h5>
            </div>
            <div class="card-body">
                <!-- Status -->
                <div class="mb-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status" form="itemForm">
                        {% for status_value, status_label in statuses %}
                        <option value="{{ status_value }}" 
                                {% if item and item.status == status_value %}selected{% endif %}
                                {% if not item and status_value == 'Inbox' %}selected{% endif %}>
                            {{ status_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Organisation -->
                <div class="mb-3">
                    <label for="organisation" class="form-label">Organisation</label>
                    <select class="form-select" id="organisation" name="organisation" form="itemForm">
                        <option value="">None</option>
                        {% for org in organisations %}
                        <option value="{{ org.id }}" 
                                {% if item and item.organisation and item.organisation.id == org.id or not item and default_organisation and default_organisation.id == org.id %}selected{% endif %}>
                            {{ org.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Requester -->
                <div class="mb-3">
                    <label for="requester" class="form-label">Requester</label>
                    <select class="form-select" id="requester" name="requester" form="itemForm">
                        <option value="">None</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" 
                                {% if item and item.requester and item.requester.id == user.id or not item and default_requester and default_requester.id == user.id %}selected{% endif %}>
                            {{ user.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Assigned To -->
                <div class="mb-3">
                    <label for="assigned_to" class="form-label">Assigned To</label>
                    <select class="form-select" id="assigned_to" name="assigned_to" form="itemForm">
                        <option value="">None</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" 
                                {% if item and item.assigned_to and item.assigned_to.id == user.id %}selected{% endif %}>
                            {{ user.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Project -->
                <div class="mb-3">
                    <label for="project" class="form-label">Project <span class="text-danger">*</span></label>
                    <select class="form-select" id="project" name="project" form="itemForm" required>
                        <option value="">Select project...</option>
                        {% for proj in projects %}
                        <option value="{{ proj.id }}" 
                                {% if item and item.project.id == proj.id %}selected
                                {% elif not item and default_project and default_project.id == proj.id %}selected
                                {% endif %}>
                            {{ proj.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Type -->
                <div class="mb-3">
                    <label for="type" class="form-label">Type <span class="text-danger">*</span></label>
                    <select class="form-select" id="type" name="type" form="itemForm" required>
                        <option value="">Select type...</option>
                        {% for item_type in item_types %}
                        <option value="{{ item_type.id }}" 
                                {% if item and item.type.id == item_type.id %}selected{% endif %}>
                            {{ item_type.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Parent Item -->
                <div class="mb-3">
                    <label for="parent" class="form-label">Parent Item</label>
                    <select class="form-select" id="parent" name="parent" form="itemForm">
                        <option value="">None</option>
                        {% if item %}
                            {% for parent_item in parent_items %}
                            <option value="{{ parent_item.id }}" 
                                    {% if item.parent and item.parent.id == parent_item.id %}selected{% endif %}>
                                {{ parent_item.title }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                
                <!-- Solution Release -->
                <div class="mb-3">
                    <label for="solution_release" class="form-label">Solution Release</label>
                    {% if item %}
                    <select class="form-select" id="solution_release" name="solution_release" form="itemForm">
                        <option value="">None</option>
                        {% for release in releases %}
                        <option value="{{ release.id }}" 
                                {% if item.solution_release and item.solution_release.id == release.id %}selected{% endif %}>
                            {{ release.version }} - {{ release.name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <select class="form-select" id="solution_release" name="solution_release" form="itemForm" disabled>
                        <option value="">None</option>
                    </select>
                    <small class="text-muted d-block">Available after creating the item</small>
                    {% endif %}
                </div>
                
                <!-- Node -->
                <div class="mb-0">
                    <label for="node" class="form-label">Node</label>
                    {% if nodes %}
                    <select class="form-select" id="node" name="node" form="itemForm">
                        <option value="">None</option>
                        {% for node in nodes %}
                        <option value="{{ node.id }}" 
                                {% if item and item.nodes.first and item.nodes.first.id == node.id %}selected{% endif %}>
                            {{ node.name }} ({{ node.type }})
                        </option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <select class="form-select" id="node" name="node" form="itemForm" disabled>
                        <option value="">None</option>
                    </select>
                    <small class="text-muted d-block">{% if not item %}Select a project first{% else %}No nodes available for this project{% endif %}</small>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Help Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Help</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small text-muted mb-0">
                    <li class="mb-2">• Use Markdown for rich formatting in descriptions</li>
                    <li class="mb-2">• Required fields are marked with *</li>
                    <li>• All fields can be updated later</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ToastUI Editor JS -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
// Initialize ToastUI Editor for Description
const descriptionEditor = new toastui.Editor({
    el: document.querySelector('#description-editor'),
    height: '400px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    {% if item and item.description %}
    initialValue: '{{ item.description|escapejs }}',
    {% else %}
    initialValue: '',
    {% endif %}
    theme: 'dark',
    usageStatistics: false
});

// Force editor to respect height constraints and enable proper scrolling
document.querySelector('#description-editor .toastui-editor-defaultUI').style.maxHeight = '400px';
document.querySelector('#description-editor .toastui-editor-defaultUI').style.overflow = 'hidden';

// Initialize ToastUI Editor for Solution Description
const solutionEditor = new toastui.Editor({
    el: document.querySelector('#solution-editor'),
    height: '400px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    {% if item and item.solution_description %}
    initialValue: '{{ item.solution_description|escapejs }}',
    {% else %}
    initialValue: '',
    {% endif %}
    theme: 'dark',
    usageStatistics: false
});

// Force editor to respect height constraints and enable proper scrolling
document.querySelector('#solution-editor .toastui-editor-defaultUI').style.maxHeight = '400px';
document.querySelector('#solution-editor .toastui-editor-defaultUI').style.overflow = 'hidden';

// Sync editor content to hidden fields on form submit
document.getElementById('itemForm').addEventListener('submit', function() {
    document.getElementById('description').value = descriptionEditor.getMarkdown();
    document.getElementById('solution_description').value = solutionEditor.getMarkdown();
});

// AI Title Generation Button
document.getElementById('ai-title-btn').addEventListener('click', async function() {
    const btn = this;
    const descriptionText = descriptionEditor.getMarkdown();
    
    if (!descriptionText || descriptionText.trim() === '') {
        showToast('error', 'Please enter a description first');
        return;
    }
    
    // Disable button and show loading state
    btn.disabled = true;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
        const response = await fetch('{% url "ai-generate-title" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ text: descriptionText })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            document.getElementById('title').value = data.title;
            showToast('success', 'Title generated successfully');
        } else {
            showToast('error', data.error || 'Failed to generate title');
        }
    } catch (error) {
        showToast('error', 'Failed to generate title');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// AI Text Optimization Button
document.getElementById('ai-optimize-btn').addEventListener('click', async function() {
    const btn = this;
    const descriptionText = descriptionEditor.getMarkdown();
    
    if (!descriptionText || descriptionText.trim() === '') {
        showToast('error', 'Please enter a description first');
        return;
    }
    
    // Disable button and show loading state
    btn.disabled = true;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Optimizing...';
    
    try {
        const response = await fetch('{% url "ai-optimize-text" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ text: descriptionText })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            descriptionEditor.setMarkdown(data.text);
            showToast('success', 'Text optimized successfully');
        } else {
            showToast('error', data.error || 'Failed to optimize text');
        }
    } catch (error) {
        showToast('error', 'Failed to optimize text');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// Handle form response
function handleFormResponse(event) {
    const xhr = event.detail.xhr;
    
    if (xhr.status === 200 || xhr.status === 201) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                // Check if mail preview exists
                if (response.mail_preview) {
                    // Show mail confirmation modal
                    showMailConfirmationModal(response.mail_preview, response.item_id, response.redirect);
                } else {
                    // No mail to send, just show success and redirect
                    showToast('success', response.message || 'Item saved successfully');
                    
                    // Redirect after a short delay
                    setTimeout(() => {
                        if (response.redirect) {
                            window.location.href = response.redirect;
                        } else if (response.item_id) {
                            window.location.href = `/items/${response.item_id}/`;
                        }
                    }, 1000);
                }
            } else {
                showToast('error', response.error || 'Failed to save item');
            }
        } catch (e) {
            showToast('error', 'An unexpected error occurred');
        }
    } else {
        try {
            const response = JSON.parse(xhr.responseText);
            showToast('error', response.error || 'Failed to save item');
        } catch (e) {
            showToast('error', 'Failed to save item');
        }
    }
}

// Show mail confirmation modal
let mailModalEventListenerAdded = false;

function showMailConfirmationModal(mailPreview, itemId, redirectUrl) {
    // Populate modal with mail preview data
    document.getElementById('mail-subject-preview').textContent = mailPreview.subject;
    
    // Sanitize and set message HTML (bleach should have sanitized on server, but double-check)
    const messagePreview = document.getElementById('mail-message-preview');
    messagePreview.innerHTML = mailPreview.message;  // Already sanitized by server
    
    // Set sender info
    const fromText = mailPreview.from_name 
        ? `${mailPreview.from_name} <${mailPreview.from_address || 'default'}>`
        : mailPreview.from_address || 'Standard-Absender';
    document.getElementById('mail-from-preview').textContent = fromText;
    
    // Set recipient info (try to get from item's requester)
    const toText = 'Anfragender (aus Item)';
    document.getElementById('mail-to-preview').textContent = toText;
    
    // Set CC if present
    const ccContainer = document.getElementById('mail-cc-container');
    if (mailPreview.cc_address) {
        document.getElementById('mail-cc-preview').textContent = mailPreview.cc_address;
        ccContainer.style.display = 'block';
    } else {
        ccContainer.style.display = 'none';
    }
    
    // Show the modal
    const modalEl = document.getElementById('mailConfirmationModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    
    // Handle send button
    const sendBtn = document.getElementById('confirmSendMailBtn');
    sendBtn.dataset.sent = '';  // Clear sent flag
    sendBtn.onclick = function() {
        sendStatusMail(itemId, mailPreview, redirectUrl, modal);
    };
    
    // Handle cancel - redirect when modal closes (only add once)
    if (!mailModalEventListenerAdded) {
        modalEl.addEventListener('hidden.bs.modal', function(e) {
            // Only redirect if modal is closed without sending
            if (!sendBtn.dataset.sent) {
                showToast('info', 'Item gespeichert - Mail nicht versendet');
                setTimeout(() => {
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    } else if (itemId) {
                        window.location.href = `/items/${itemId}/`;
                    }
                }, 1000);
            }
        });
        mailModalEventListenerAdded = true;
    }
}

// Send status mail
function sendStatusMail(itemId, mailPreview, redirectUrl, modal) {
    const sendBtn = document.getElementById('confirmSendMailBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Wird gesendet...';
    
    fetch(`/items/${itemId}/send-status-mail/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            subject: mailPreview.subject,
            message: mailPreview.message,
            to: '',  // Will use requester email from backend
            from_address: mailPreview.from_address,
            cc_address: mailPreview.cc_address
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sendBtn.dataset.sent = 'true';
            showToast('success', 'Mail erfolgreich versendet!');
            modal.hide();
            setTimeout(() => {
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                } else if (itemId) {
                    window.location.href = `/items/${itemId}/`;
                }
            }, 1000);
        } else {
            showToast('error', data.error || 'Fehler beim Mailversand');
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send me-1" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg> Mail senden';
        }
    })
    .catch(error => {
        console.error('Mail send error:', error);  // Log error for debugging
        showToast('error', 'Netzwerkfehler beim Mailversand');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send me-1" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg> Mail senden';
    });
}

// Toast notification function
function showToast(type, message) {
    const toastEl = document.getElementById(type === 'success' ? 'successToast' : 'errorToast');
    if (!toastEl) {
        // Create toast elements if they don't exist (for item form page)
        const container = document.querySelector('.toast-container') || createToastContainer();
        const toast = createToastElement(type, message);
        container.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 5000 });
        bsToast.show();
        toast.addEventListener('hidden.bs.toast', () => toast.remove());
        return;
    }
    
    const messageEl = document.getElementById(type === 'success' ? 'toastMessage' : 'errorToastMessage');
    messageEl.textContent = message;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

function createToastElement(type, message) {
    const toastEl = document.createElement('div');
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
    toastEl.className = `toast align-items-center text-white ${bgClass} border-0`;
    toastEl.setAttribute('role', 'alert');
    
    // Create structure without innerHTML to avoid XSS
    const flexDiv = document.createElement('div');
    flexDiv.className = 'd-flex';
    
    const bodyDiv = document.createElement('div');
    bodyDiv.className = 'toast-body';
    bodyDiv.textContent = message;  // Use textContent to prevent XSS
    
    const closeBtn = document.createElement('button');
    closeBtn.type = 'button';
    closeBtn.className = 'btn-close btn-close-white me-2 m-auto';
    closeBtn.setAttribute('data-bs-dismiss', 'toast');
    closeBtn.setAttribute('aria-label', 'Close');
    
    flexDiv.appendChild(bodyDiv);
    flexDiv.appendChild(closeBtn);
    toastEl.appendChild(flexDiv);
    
    return toastEl;
}
</script>

<!-- Include mail confirmation modal -->
{% include 'partials/mail_confirmation_modal.html' %}

{% endblock %}
