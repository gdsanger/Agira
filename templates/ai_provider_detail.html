{% extends "base.html" %}

{% block title %}{{ provider.name }} - AI Provider - Agira{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'ai-providers' %}">AI Providers</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ provider.name }}</li>
        </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>{{ provider.name }}</h1>
            <p class="text-muted">{{ provider.get_provider_type_display }}</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-danger" 
                    hx-post="{% url 'ai-provider-delete' provider.id %}"
                    hx-confirm="Are you sure you want to delete this provider and all its models?">
                Delete Provider
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Provider Details -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Provider Details</h5>
            </div>
            <div class="card-body">
                <form hx-post="{% url 'ai-provider-update' provider.id %}" 
                      hx-swap="none"
                      hx-on::after-request="if(event.detail.successful) showToast('Provider updated successfully', 'success')">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ provider.name }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="provider_type" class="form-label">Provider Type</label>
                        <select class="form-select" id="provider_type" name="provider_type" required>
                            {% for type_value, type_label in provider_types %}
                            <option value="{{ type_value }}" {% if provider.provider_type == type_value %}selected{% endif %}>
                                {{ type_label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="api_key" class="form-label">API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="api_key" name="api_key" value="********************" placeholder="Leave empty to keep current">
                            <button type="button" class="btn btn-outline-secondary" onclick="copyApiKey({{ provider.id }})">
                                üìã Copy
                            </button>
                        </div>
                        <div class="form-text">API key is encrypted. Click Copy to get the actual value.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="organization_id" class="form-label">Organization ID</label>
                        <input type="text" class="form-control" id="organization_id" name="organization_id" value="{{ provider.organization_id }}">
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="active" name="active" {% if provider.active %}checked{% endif %}>
                        <label class="form-check-label" for="active">Active</label>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Created: {{ provider.created_at|date:"Y-m-d H:i" }}</small><br>
                        <small class="text-muted">Updated: {{ provider.updated_at|date:"Y-m-d H:i" }}</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
        
        <!-- Fetch Models -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Fetch Available Models</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Fetch available models from the provider API</p>
                <button type="button" class="btn btn-outline-primary" onclick="fetchModels({{ provider.id }})">
                    üîÑ Fetch Models
                </button>
                <div id="fetch-models-result" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <!-- AI Models List -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">AI Models</h5>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addModelModal">
                    + Add Model
                </button>
            </div>
            <div class="card-body" id="models-list">
                {% include "partials/ai_models_list.html" %}
            </div>
        </div>
    </div>
</div>

<!-- Add Model Modal -->
<div class="modal fade" id="addModelModal" tabindex="-1" aria-labelledby="addModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="addModelModalLabel">Add AI Model</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form hx-post="{% url 'ai-model-create' provider.id %}" 
                  hx-target="#models-list"
                  hx-on::after-request="if(event.detail.successful) bootstrap.Modal.getInstance(document.getElementById('addModelModal')).hide(); showToast('Model added successfully', 'success');">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="model_name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="model_name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="model_id" class="form-label">Model ID</label>
                        <input type="text" class="form-control" id="model_id" name="model_id" required>
                        <div class="form-text">Provider-specific model identifier (e.g., gpt-4, gemini-pro)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="input_price" class="form-label">Input Price (per 1M tokens)</label>
                        <input type="number" step="0.0001" class="form-control" id="input_price" name="input_price_per_1m_tokens">
                    </div>
                    
                    <div class="mb-3">
                        <label for="output_price" class="form-label">Output Price (per 1M tokens)</label>
                        <input type="number" step="0.0001" class="form-control" id="output_price" name="output_price_per_1m_tokens">
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="model_active" name="active" checked>
                        <label class="form-check-label" for="model_active">Active</label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_default" name="is_default">
                        <label class="form-check-label" for="is_default">Set as default model</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Model</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Model Modal -->
<div class="modal fade" id="editModelModal" tabindex="-1" aria-labelledby="editModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="editModelModalLabel">Edit AI Model</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editModelForm" hx-target="#models-list"
                  hx-on::after-request="if(event.detail.successful) bootstrap.Modal.getInstance(document.getElementById('editModelModal')).hide(); showToast('Model updated successfully', 'success');">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_model_name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="edit_model_name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_model_id" class="form-label">Model ID</label>
                        <input type="text" class="form-control" id="edit_model_id" name="model_id" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_input_price" class="form-label">Input Price (per 1M tokens)</label>
                        <input type="number" step="0.0001" class="form-control" id="edit_input_price" name="input_price_per_1m_tokens">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_output_price" class="form-label">Output Price (per 1M tokens)</label>
                        <input type="number" step="0.0001" class="form-control" id="edit_output_price" name="output_price_per_1m_tokens">
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_model_active" name="active">
                        <label class="form-check-label" for="edit_model_active">Active</label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_default" name="is_default">
                        <label class="form-check-label" for="edit_is_default">Set as default model</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Model</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11;">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header" id="toast-header">
            <strong class="me-auto" id="toast-title">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body">
            <!-- Toast message will be inserted here -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function showToast(message, severity = 'info') {
        const toastEl = document.getElementById('toast');
        const toastBody = document.getElementById('toast-body');
        const toastHeader = document.getElementById('toast-header');
        
        toastBody.textContent = message;
        
        // Remove old severity classes
        toastEl.classList.remove('toast-success', 'toast-error', 'toast-warning', 'toast-info');
        
        // Add severity class
        if (severity === 'success') {
            toastEl.classList.add('toast-success');
        } else if (severity === 'error') {
            toastEl.classList.add('toast-error');
        } else if (severity === 'warning') {
            toastEl.classList.add('toast-warning');
        } else {
            toastEl.classList.add('toast-info');
        }
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
    
    async function copyApiKey(providerId) {
        try {
            const response = await fetch(`/ai-providers/${providerId}/get-api-key/`);
            const data = await response.json();
            
            if (data.api_key) {
                await navigator.clipboard.writeText(data.api_key);
                showToast('API key copied to clipboard', 'success');
            }
        } catch (error) {
            showToast('Failed to copy API key: ' + error.message, 'error');
        }
    }
    
    async function fetchModels(providerId) {
        const resultDiv = document.getElementById('fetch-models-result');
        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> Fetching models...';
        
        try {
            const response = await fetch(`/ai-providers/${providerId}/fetch-models/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Found ${data.total_count} models:</strong>
                        <ul class="mb-0 mt-2">
                            ${data.models.map(m => `<li>${m.name} (${m.model_id})</li>`).join('')}
                        </ul>
                        <hr>
                        <small>‚úÖ Created: ${data.created_count} | ‚ÑπÔ∏è Already existed: ${data.existing_count}</small>
                    </div>
                `;
                showToast(`Saved ${data.created_count} new models, ${data.existing_count} already existed`, 'success');
                
                // Refresh the models list (element with id="models-list" in the template)
                htmx.ajax('GET', window.location.href, {target: '#models-list', select: '#models-list'});
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                showToast(data.error, 'error');
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            showToast('Failed to fetch models: ' + error.message, 'error');
        }
    }
    
    function editModel(modelId, name, model_id, inputPrice, outputPrice, active, isDefault) {
        const form = document.getElementById('editModelForm');
        form.setAttribute('hx-post', `/ai-providers/{{ provider.id }}/models/${modelId}/update/`);
        
        document.getElementById('edit_model_name').value = name;
        document.getElementById('edit_model_id').value = model_id;
        document.getElementById('edit_input_price').value = inputPrice || '';
        document.getElementById('edit_output_price').value = outputPrice || '';
        document.getElementById('edit_model_active').checked = active;
        document.getElementById('edit_is_default').checked = isDefault;
        
        // Re-initialize HTMX on the form
        htmx.process(form);
        
        const modal = new bootstrap.Modal(document.getElementById('editModelModal'));
        modal.show();
    }
    
    // Listen for showToast events from HTMX
    document.body.addEventListener('showToast', function(evt) {
        showToast('Changes saved successfully', 'success');
    });
</script>
{% endblock %}
