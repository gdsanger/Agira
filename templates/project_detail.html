{% extends "base.html" %}
{% load static %}

{% block title %}{{ project.name }} - Agira{% endblock %}

{% block extra_head %}
<!-- Markdown Viewer Styles -->
<style>
.markdown-viewer {
    width: 100%;
    min-height: 300px;
    max-height: 450px;
    overflow-y: auto;
    padding: 20px;
    background-color: #1a1a1a;
    border: 1px solid #333;
    border-radius: 4px;
}
.markdown-viewer h1 {
    font-size: 2em;
    margin-top: 0.67em;
    margin-bottom: 0.67em;
    border-bottom: 1px solid #444;
    padding-bottom: 0.3em;
}
.markdown-viewer h2 {
    font-size: 1.5em;
    margin-top: 0.83em;
    margin-bottom: 0.83em;
    border-bottom: 1px solid #444;
    padding-bottom: 0.3em;
}
.markdown-viewer h3 {
    font-size: 1.17em;
    margin-top: 1em;
    margin-bottom: 1em;
}
.markdown-viewer code {
    background-color: #2a2a2a;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    color: #e06c75;
}
.markdown-viewer pre {
    background-color: #2a2a2a;
    padding: 16px;
    border-radius: 6px;
    overflow-x: auto;
}
.markdown-viewer pre code {
    background-color: transparent;
    padding: 0;
    color: #abb2bf;
}
.markdown-viewer blockquote {
    border-left: 4px solid #444;
    padding-left: 16px;
    margin-left: 0;
    color: #999;
}
.markdown-viewer ul, .markdown-viewer ol {
    padding-left: 2em;
}
.markdown-viewer a {
    color: #61afef;
    text-decoration: none;
}
.markdown-viewer a:hover {
    text-decoration: underline;
}
.markdown-viewer strong {
    font-weight: bold;
    color: #e5c07b;
}
.markdown-viewer em {
    font-style: italic;
    color: #c678dd;
}

/* Node Tree Styles */
.node-tree {
    padding-left: 0;
}
.node-tree-item {
    margin-bottom: 0.25rem;
}
.node-tree-node {
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}
.node-tree-node:hover {
    background-color: rgba(13, 110, 253, 0.1);
}
.node-tree-node.selected {
    background-color: rgba(13, 110, 253, 0.2);
    font-weight: 500;
}
.node-tree-children {
    padding-left: 1rem;
    margin-top: 0.25rem;
}
.node-expand-icon {
    transition: transform 0.2s;
    font-size: 0.875rem;
}
.node-name {
    flex-grow: 1;
}
</style>
{% endblock %}

{% block content %}
<!-- Recent touch marker for sidebar -->
<div style="display: none;" 
     data-recent-touch="1" 
     data-recent-type="project" 
     data-recent-id="{{ project.id }}" 
     data-recent-title="Projekt: {{ project.name }}" 
     data-recent-status="" 
     data-recent-url="{% url 'project-detail' project.id %}"></div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'projects' %}">Projects</a></li>
        <li class="breadcrumb-item active">{{ project.name }}</li>
    </ol>
</nav>

<!-- 2-Column Layout -->
<div class="detail-layout">
    <!-- Left Column: Main Content (2/3) -->
    <div class="detail-main">
        <!-- Project Header -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h1 class="mb-0">{{ project.name }}</h1>
                <div class="d-flex btn-toolbar" role="group" aria-label="Project Actions">
                    <!-- Weaviate Status Button -->
                    <div 
                        hx-get="{% url 'weaviate-status' 'project' project.id %}"
                        hx-trigger="load"
                        hx-swap="innerHTML">
                        <!-- Button will be loaded via HTMX -->
                    </div>
                    <a href="{% url 'project-edit' project.id %}" class="btn btn-outline-primary">
                        Edit
                    </a>
                    <button class="btn btn-outline-danger" 
                            hx-post="{% url 'project-delete' project.id %}"
                            hx-confirm="Are you sure you want to delete this project? This action cannot be undone."
                            hx-swap="none"
                            hx-on::after-request="handleDeleteResponse(event)">
                        Delete
                    </button>
                </div>
            </div>
            
            <!-- Description with Markdown Viewer -->
            {% if description_html %}
            <div class="markdown-viewer">
                {{ description_html }}
            </div>
            {% else %}
            <p class="text-muted">No description</p>
            {% endif %}
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="projectTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab" aria-controls="items">
                    Items <span class="badge bg-secondary">{{ project.items.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes" type="button" role="tab" aria-controls="nodes">
                    Nodes <span class="badge bg-secondary">{{ project.nodes.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="releases-tab" data-bs-toggle="tab" data-bs-target="#releases" type="button" role="tab" aria-controls="releases">
                    Releases <span class="badge bg-secondary">{{ project.releases.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients" type="button" role="tab" aria-controls="clients">
                    Clients <span class="badge bg-secondary">{{ project.clients.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#project-attachments" type="button" role="tab" aria-controls="project-attachments">
                    Attachments <span class="badge bg-secondary">{{ attachments_count }}</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="projectTabContent">
            <!-- Items Tab -->
            <div class="tab-pane fade show active" id="items" role="tabpanel" aria-labelledby="items-tab"
                 hx-get="{% url 'project-items-tab' project.id %}"
                 hx-trigger="load once"
                 hx-swap="innerHTML"
                 hx-on::before-request="applyItemsFiltersFromStorage(event)">
                <!-- Content will be loaded via HTMX -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Nodes Tab -->
            <div class="tab-pane fade" id="nodes" role="tabpanel" aria-labelledby="nodes-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Nodes</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addNodeModal">
                        + Add Node
                    </button>
                </div>
                
                {% if project.nodes.count > 0 %}
                <div class="row">
                    <!-- Left Panel: Tree View -->
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Node Hierarchy</h6>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                <div id="nodeTree">
                                    <!-- Tree will be loaded here -->
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Panel: Node Detail -->
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0" id="nodeDetailTitle">Node Details</h6>
                            </div>
                            <div class="card-body" id="nodeDetailContent" style="min-height: 400px;">
                                <div class="text-muted text-center py-5">
                                    <i class="bi bi-diagram-3" style="font-size: 3rem;"></i>
                                    <p class="mt-3">Select a node from the tree to view details</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    No nodes in this project yet.
                </div>
                {% endif %}
            </div>

            <!-- Releases Tab -->
            <div class="tab-pane fade" id="releases" role="tabpanel" aria-labelledby="releases-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Releases</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addReleaseModal">
                        + Add Release
                    </button>
                </div>
                {% if project.releases.count > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Version</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Planned Date</th>
                                <th>Updated</th>
                                <th>Change</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for release in project.releases.all %}
                            <tr>
                                <td><strong>{{ release.name }}</strong></td>
                                <td>{{ release.version }}</td>
                                <td>
                                    {% if release.type %}
                                    <span class="badge bg-secondary">{{ release.type }}</span>
                                    {% else %}
                                    <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if release.status == 'Planned' %}
                                    <span class="badge bg-info">{{ release.status }}</span>
                                    {% elif release.status == 'Working' %}
                                    <span class="badge bg-primary">{{ release.status }}</span>
                                    {% elif release.status == 'Closed' %}
                                    <span class="badge bg-success">{{ release.status }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ release.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{% if release.planned_date %}{{ release.planned_date|date:"Y-m-d" }}{% else %}‚Äî{% endif %}</td>
                                <td>{% if release.updated_at %}{{ release.updated_at|date:"Y-m-d H:i" }}{% else %}‚Äî{% endif %}</td>
                                <td>
                                    {% with change=release.get_primary_change %}
                                    {% if change %}
                                    <a href="{% url 'change-detail' change.id %}" class="badge bg-success text-decoration-none">
                                        View Change
                                    </a>
                                    {% else %}
                                    <button class="btn btn-sm btn-outline-success"
                                            hx-post="{% url 'release-create-change' release.id %}"
                                            hx-swap="none"
                                            hx-on::after-request="handleCreateChangeResponse(event)">
                                        + Create Change
                                    </button>
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" 
                                            onclick="editRelease({{ release.id }}, '{{ release.name|escapejs }}', '{{ release.version|escapejs }}', '{{ release.type }}', '{{ release.status }}', '{{ release.planned_date|date:"Y-m-d"|default:"" }}')">
                                        Edit
                                    </button>
                                    {% if release.status != 'Closed' %}
                                    <button class="btn btn-sm btn-outline-success me-1"
                                            hx-post="{% url 'project-close-release' project.id release.id %}"
                                            hx-confirm="Are you sure you want to close this release?"
                                            hx-swap="none"
                                            hx-on::after-request="handleReleaseCloseResponse(event)">
                                        Close
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-danger"
                                            hx-post="{% url 'project-delete-release' project.id release.id %}"
                                            hx-confirm="Are you sure you want to delete this release?"
                                            hx-swap="none"
                                            hx-on::after-request="handleReleaseDeleteResponse(event)">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    No releases in this project yet.
                </div>
                {% endif %}
            </div>

            <!-- Clients Tab -->
            <div class="tab-pane fade" id="clients" role="tabpanel" aria-labelledby="clients-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Clients</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        + Add Client
                    </button>
                </div>
                {% if project.clients.count > 0 %}
                <div class="list-group">
                    {% for client in project.clients.all %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ client.name }}</span>
                        <button class="btn btn-sm btn-danger" 
                                hx-post="{% url 'project-remove-client' project.id %}"
                                hx-vals='{"organisation_id": "{{ client.id }}"}'
                                hx-swap="none"
                                hx-on::after-request="handleClientResponse(event)">
                            Remove
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    No clients assigned to this project yet.
                </div>
                {% endif %}
            </div>
            
            <!-- Attachments Tab -->
            <div class="tab-pane fade" id="project-attachments" role="tabpanel" aria-labelledby="attachments-tab"
                 hx-get="{% url 'project-attachments-tab' project.id %}"
                 hx-trigger="load once"
                 hx-swap="innerHTML">
                <!-- Content will be loaded via HTMX -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Sidebar (1/3) -->
    <div class="detail-sidebar">
        <!-- Status Card -->
        <div class="project-info-card">
            <div class="project-info-label">Status</div>
            <div class="project-info-value">
                {% if project.status == 'New' %}
                <span class="badge bg-info fs-6">{{ project.status }}</span>
                {% elif project.status == 'Working' %}
                <span class="badge bg-primary fs-6">{{ project.status }}</span>
                {% elif project.status == 'Finished' %}
                <span class="badge bg-success fs-6">{{ project.status }}</span>
                {% elif project.status == 'Canceled' %}
                <span class="badge bg-secondary fs-6">{{ project.status }}</span>
                {% else %}
                <span class="badge bg-secondary fs-6">{{ project.status }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Repository Card -->
        {% if project.github_owner and project.github_repo %}
        <div class="project-info-card">
            <div class="project-info-label">Repository</div>
            <div class="project-info-value">
                <a href="https://github.com/{{ project.github_owner }}/{{ project.github_repo }}" 
                   target="_blank" 
                   class="d-flex align-items-center gap-2">
                    <span>{{ project.github_owner }}/{{ project.github_repo }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
                        <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
                    </svg>
                </a>
            </div>
            <div class="mt-3">
                <button 
                    id="importGitHubIssuesBtn"
                    class="btn btn-sm btn-outline-primary w-100"
                    hx-post="{% url 'project-import-github-issues' project.id %}"
                    hx-swap="none"
                    hx-indicator="#importSpinner"
                    hx-on::after-request="handleImportResponse(event)">
                    <span id="importBtnText">üì• Import Closed Issues</span>
                    <span id="importSpinner" class="htmx-indicator spinner-border spinner-border-sm ms-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </span>
                </button>
            </div>
            <div class="mt-2">
                <button 
                    id="syncMarkdownBtn"
                    class="btn btn-sm btn-outline-secondary w-100"
                    hx-post="{% url 'project-sync-markdown' project.id %}"
                    hx-swap="none"
                    hx-indicator="#syncMarkdownSpinner"
                    hx-on::after-request="handleSyncMarkdownResponse(event)">
                    <span id="syncMarkdownBtnText">üìù Sync Markdown from GitHub</span>
                    <span id="syncMarkdownSpinner" class="htmx-indicator spinner-border spinner-border-sm ms-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </span>
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Item Statistics -->
        <div class="project-info-card">
            <div class="project-info-label">Item Statistics</div>
            <div class="project-info-value">
                <div class="d-flex flex-column gap-2">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">üì• Inbox</span>
                        <span>{{ project.inbox_count|default:0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">üìã Backlog</span>
                        <span>{{ project.backlog_count|default:0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">‚ö° Working</span>
                        <span>{{ project.working_count|default:0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">‚úÖ Total</span>
                        <strong>{{ project.items.count }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals for Adding Resources (kept for backward compatibility) -->
{% include "partials/project_modals.html" %}

<!-- Include Weaviate Modal -->
{% include 'partials/weaviate_modal.html' %}

<!-- Attachment Viewer Modal -->
<div class="modal fade" id="attachmentViewerModal" tabindex="-1" aria-labelledby="attachmentViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attachmentViewerModalLabel">Attachment Viewer</h5>
                <a href="#" id="attachmentDownloadBtn" class="btn btn-sm btn-outline-primary me-2" title="Download attachment" style="display: none;">
                    <i class="bi bi-download"></i> Download
                </a>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="attachmentViewerContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>
{% endblock %}

{% block extra_js %}
<script>
// Function to apply filters from localStorage to HTMX request
// This intercepts the HTMX request before it's sent and appends filter parameters from localStorage
function applyItemsFiltersFromStorage(event) {
    const projectId = {{ project.id|escapejs }};
    const storageKeyStatus = `project_${projectId}_items_status_filter`;
    const storageKeyType = `project_${projectId}_items_type_filter`;
    
    try {
        const savedStatuses = localStorage.getItem(storageKeyStatus);
        const savedTypes = localStorage.getItem(storageKeyType);
        
        if (savedStatuses || savedTypes) {
            // Build query parameters from localStorage
            const params = new URLSearchParams();
            
            if (savedStatuses) {
                const statusArray = JSON.parse(savedStatuses);
                statusArray.forEach(status => params.append('status', status));
            }
            
            if (savedTypes) {
                const typeArray = JSON.parse(savedTypes);
                typeArray.forEach(type => params.append('type', type));
            }
            
            // Update the HTMX request path with query parameters
            const currentPath = event.detail.path;
            const separator = currentPath.includes('?') ? '&' : '?';
            event.detail.path = currentPath + separator + params.toString();
        }
    } catch (e) {
        console.warn('Could not apply filters from localStorage:', e);
    }
}

// Tab persistence functionality
(function() {
    const projectId = {{ project.id|escapejs }};
    const storageKey = 'projectDetail.activeTab.{{ project.id|escapejs }}';
    
    // List of valid tab IDs for this view
    const validTabIds = ['items-tab', 'nodes-tab', 'releases-tab', 'clients-tab', 'attachments-tab'];
    
    // Restore active tab on page load
    function restoreActiveTab() {
        try {
            const savedTabId = localStorage.getItem(storageKey);
            
            if (savedTabId && validTabIds.includes(savedTabId)) {
                // Find the tab button with the saved ID
                const tabButton = document.getElementById(savedTabId);
                
                if (tabButton) {
                    // Use Bootstrap's Tab API to show the saved tab
                    const tab = new bootstrap.Tab(tabButton);
                    tab.show();
                } else {
                    // If saved tab doesn't exist, localStorage will be updated when first tab is shown
                    console.debug('Saved tab not found, using default');
                }
            }
            // If no saved tab, the first tab (default) remains active
        } catch (e) {
            // Silently fail if localStorage is not available
            console.debug('localStorage not available:', e);
        }
    }
    
    // Save active tab when user switches tabs
    function saveActiveTab(event) {
        try {
            const tabId = event.target.id;
            if (tabId && validTabIds.includes(tabId)) {
                localStorage.setItem(storageKey, tabId);
            }
        } catch (e) {
            // Silently fail if localStorage is not available
            console.debug('localStorage not available:', e);
        }
    }
    
    // Attach event listeners to all tab buttons
    function initTabPersistence() {
        const tabButtons = document.querySelectorAll('#projectTabs button[data-bs-toggle="tab"]');
        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', saveActiveTab);
        });
        
        // Restore the active tab after DOM is ready
        restoreActiveTab();
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTabPersistence);
    } else {
        initTabPersistence();
    }
})();

// Handle delete response
function handleDeleteResponse(event) {
    const xhr = event.detail.xhr;
    
    if (xhr.status === 200) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showToast('success', 'Success', response.message || 'Project deleted successfully');
                setTimeout(() => {
                    window.location.href = response.redirect || '/projects/';
                }, 1000);
            } else {
                showToast('error', 'Error', response.error || 'Failed to delete project');
            }
        } catch (e) {
            showToast('error', 'Error', 'An unexpected error occurred');
        }
    } else {
        showToast('error', 'Error', 'Failed to delete project');
    }
}

// Handle client add/remove response
function handleClientResponse(event) {
    const xhr = event.detail.xhr;
    
    if (xhr.status === 200) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showToast('success', 'Success', response.message);
                // Reload page to update client list
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', 'Error', response.error || 'Operation failed');
            }
        } catch (e) {
            showToast('error', 'Error', 'An unexpected error occurred');
        }
    } else {
        showToast('error', 'Error', 'Operation failed');
    }
}

// Handle release delete response
function handleReleaseDeleteResponse(event) {
    const xhr = event.detail.xhr;
    
    if (xhr.status === 200) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showToast('success', 'Success', response.message || 'Release deleted successfully');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', 'Error', response.error || 'Failed to delete release');
            }
        } catch (e) {
            showToast('error', 'Error', 'An unexpected error occurred');
        }
    } else {
        showToast('error', 'Error', 'Failed to delete release');
    }
}

// Handle release close response
function handleReleaseCloseResponse(event) {
    const xhr = event.detail.xhr;
    
    if (xhr.status === 200) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showToast('success', 'Success', response.message || 'Release closed successfully');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', 'Error', response.error || 'Failed to close release');
            }
        } catch (e) {
            showToast('error', 'Error', 'An unexpected error occurred');
        }
    } else {
        try {
            const response = JSON.parse(xhr.responseText);
            showToast('error', 'Error', response.error || 'Failed to close release');
        } catch (e) {
            showToast('error', 'Error', 'Failed to close release');
        }
    }
}

// Edit release function
function editRelease(id, name, version, type, status, plannedDate) {
    const modal = new bootstrap.Modal(document.getElementById('editReleaseModal'));
    const form = document.getElementById('editReleaseForm');
    
    // Set form action URL
    form.setAttribute('hx-post', `/projects/{{ project.id }}/releases/${id}/update/`);
    
    // Reinitialize HTMX for the form after setting the attribute
    htmx.process(form);
    
    // Populate form fields
    document.getElementById('editReleaseId').value = id;
    document.getElementById('editReleaseName').value = name;
    document.getElementById('editReleaseVersion').value = version;
    document.getElementById('editReleaseType').value = type || '';
    document.getElementById('editReleaseStatus').value = status || 'Planned';
    document.getElementById('editReleasePlannedDate').value = plannedDate || '';
    
    // Show modal
    modal.show();
}

function deleteProjectAttachment(attachmentId) {
    fetch(`/projects/attachments/${attachmentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            htmx.ajax('GET', "{% url 'project-attachments-tab' project.id %}", {
                target: '#project-attachments',
                swap: 'innerHTML'
            });
            showToast('success', 'Success', 'Attachment deleted successfully');
        } else {
            showToast('error', 'Error', data.error || 'Failed to delete attachment');
        }
    })
    .catch(() => {
        showToast('error', 'Error', 'An error occurred while deleting the attachment');
    });
}

function viewAttachment(attachmentId, filename, contentType) {
    const modal = new bootstrap.Modal(document.getElementById('attachmentViewerModal'));
    const modalTitle = document.getElementById('attachmentViewerModalLabel');
    const modalContent = document.getElementById('attachmentViewerContent');
    const downloadBtn = document.getElementById('attachmentDownloadBtn');
    
    modalTitle.textContent = filename;
    modalContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Set download button URL and show it
    downloadBtn.href = `/projects/attachments/${attachmentId}/download/`;
    downloadBtn.style.display = 'inline-block';
    
    modal.show();
    
    // Determine if we can view this file type
    const viewableTypes = ['.md', '.txt', '.pdf', '.html', '.htm'];
    const extension = filename.substring(filename.lastIndexOf('.')).toLowerCase();
    const isViewable = viewableTypes.includes(extension);
    
    if (isViewable) {
        // Fetch and display content
        fetch(`/projects/attachments/${attachmentId}/view/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (extension === '.md') {
                        // Render markdown
                        modalContent.innerHTML = `<div class="markdown-viewer">${data.content_html}</div>`;
                    } else if (extension === '.pdf') {
                        // Show PDF in iframe
                        modalContent.innerHTML = `<iframe src="data:application/pdf;base64,${data.content_base64}" style="width: 100%; height: 600px;" frameborder="0"></iframe>`;
                    } else if (extension === '.html' || extension === '.htm') {
                        // Show HTML in iframe for safety - using DOM manipulation with strict sandboxing
                        const iframe = document.createElement('iframe');
                        iframe.style.width = '100%';
                        iframe.style.height = '600px';
                        iframe.style.background = 'white';
                        iframe.setAttribute('frameborder', '0');
                        // Strict sandboxing - only allow same-origin, no scripts
                        iframe.setAttribute('sandbox', 'allow-same-origin');
                        // Create a blob URL for the content instead of using srcdoc
                        const blob = new Blob([data.content], { type: 'text/html' });
                        const blobUrl = URL.createObjectURL(blob);
                        modalContent.innerHTML = '';
                        modalContent.appendChild(iframe);
                        iframe.src = blobUrl;
                        // Clean up blob URL when modal is closed
                        document.getElementById('attachmentViewerModal').addEventListener('hidden.bs.modal', function cleanup() {
                            URL.revokeObjectURL(blobUrl);
                            this.removeEventListener('hidden.bs.modal', cleanup);
                        });
                    } else {
                        // Plain text
                        modalContent.innerHTML = `<pre style="white-space: pre-wrap; background-color: #1a1a1a; padding: 20px; border-radius: 4px; max-height: 600px; overflow-y: auto;">${data.content}</pre>`;
                    }
                } else {
                    modalContent.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to load attachment'}</div>`;
                }
            })
            .catch(error => {
                modalContent.innerHTML = `<div class="alert alert-danger">An error occurred while loading the attachment</div>`;
            });
    } else {
        // Download the file
        modal.hide();
        window.location.href = `/projects/attachments/${attachmentId}/download/`;
    }
}

// Handle import GitHub issues response
function handleImportResponse(event) {
    const xhr = event.detail.xhr;
    const btn = document.getElementById('importGitHubIssuesBtn');
    
    if (xhr.status === 200) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showToast('success', 'Import Complete', response.message);
                // Reload page to show newly imported items
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', 'Import Failed', response.error || 'Failed to import issues');
            }
        } catch (e) {
            showToast('error', 'Error', 'An unexpected error occurred');
        }
    } else {
        try {
            const response = JSON.parse(xhr.responseText);
            showToast('error', 'Import Failed', response.error || 'Failed to import issues');
        } catch (e) {
            showToast('error', 'Error', 'Failed to import issues');
        }
    }
}

function handleSyncMarkdownResponse(event) {
    const xhr = event.detail.xhr;
    const btn = document.getElementById('syncMarkdownBtn');
    
    if (xhr.status === 200) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showToast('success', 'Sync Complete', response.message);
                // Reload page to show newly synced attachments
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', 'Sync Failed', response.error || 'Failed to sync markdown files');
            }
        } catch (e) {
            showToast('error', 'Error', 'An unexpected error occurred');
        }
    } else {
        try {
            const response = JSON.parse(xhr.responseText);
            showToast('error', 'Sync Failed', response.error || 'Failed to sync markdown files');
        } catch (e) {
            showToast('error', 'Error', 'Failed to sync markdown files');
        }
    }
}

// Toast notification function
function showToast(type, title, message) {
    // If bootstrap is not available, use alert
    if (typeof bootstrap === 'undefined') {
        alert(`${title}: ${message}`);
        return;
    }
    
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(t => {
        const bsToast = bootstrap.Toast.getInstance(t);
        if (bsToast) bsToast.hide();
    });
    
    // Create toast container if it doesn't exist
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    
    // Create toast element
    const toastEl = document.createElement('div');
    toastEl.className = `toast toast-${type}`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    toastEl.innerHTML = `
        <div class="toast-header">
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    container.appendChild(toastEl);
    
    const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
    toast.show();
    
    // Remove from DOM after hidden
    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}

// Node Tree Management
const NodeTreeManager = {
    projectId: {{ project.id }},
    selectedNodeId: null,
    
    init() {
        // Load tree when nodes tab is shown
        const nodesTab = document.getElementById('nodes-tab');
        if (nodesTab) {
            // Try Bootstrap event if available
            nodesTab.addEventListener('shown.bs.tab', () => {
                this.loadTree();
            });
            
            // Also add click listener as fallback
            nodesTab.addEventListener('click', () => {
                setTimeout(() => this.loadTree(), 100);
            });
        }
        
        // Load tree immediately if nodes tab is active
        if (document.getElementById('nodes').classList.contains('show')) {
            this.loadTree();
        }
    },
    
    loadTree() {
        const treeContainer = document.getElementById('nodeTree');
        if (!treeContainer) return;
        
        fetch(`/projects/${this.projectId}/nodes/tree/`, {
            credentials: 'same-origin'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                this.renderTree(data.tree, treeContainer);
            })
            .catch(error => {
                console.error('Error loading tree:', error);
                treeContainer.innerHTML = '<div class="alert alert-danger">Failed to load tree</div>';
            });
    },
    
    renderTree(nodes, container) {
        if (nodes.length === 0) {
            container.innerHTML = '<div class="text-muted p-2">No nodes yet</div>';
            return;
        }
        
        const ul = document.createElement('ul');
        ul.className = 'node-tree list-unstyled';
        
        nodes.forEach(node => {
            const li = this.createTreeNode(node);
            ul.appendChild(li);
        });
        
        container.innerHTML = '';
        container.appendChild(ul);
    },
    
    createTreeNode(node) {
        const li = document.createElement('li');
        li.className = 'node-tree-item';
        li.dataset.nodeId = node.id;
        
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'node-tree-node d-flex align-items-center';
        
        // Expand/collapse icon
        if (node.children && node.children.length > 0) {
            const expandIcon = document.createElement('i');
            expandIcon.className = 'bi bi-chevron-right node-expand-icon me-1';
            expandIcon.style.cursor = 'pointer';
            expandIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggleNode(li);
            });
            nodeDiv.appendChild(expandIcon);
        } else {
            const spacer = document.createElement('span');
            spacer.className = 'me-3';
            spacer.innerHTML = '&nbsp;';
            nodeDiv.appendChild(spacer);
        }
        
        // Node icon
        const nodeIcon = document.createElement('i');
        nodeIcon.className = 'bi bi-circle-fill me-2';
        nodeIcon.style.fontSize = '0.5rem';
        nodeIcon.style.color = this.getNodeColor(node.type);
        nodeDiv.appendChild(nodeIcon);
        
        // Node name
        const nodeName = document.createElement('span');
        nodeName.className = 'node-name';
        nodeName.textContent = node.name;
        nodeName.style.cursor = 'pointer';
        nodeDiv.appendChild(nodeName);
        
        // Click handler for node selection
        nodeDiv.addEventListener('click', () => {
            this.selectNode(node.id);
        });
        
        li.appendChild(nodeDiv);
        
        // Add children
        if (node.children && node.children.length > 0) {
            const childrenUl = document.createElement('ul');
            childrenUl.className = 'node-tree-children list-unstyled ms-3';
            childrenUl.style.display = 'none';
            
            node.children.forEach(child => {
                const childLi = this.createTreeNode(child);
                childrenUl.appendChild(childLi);
            });
            
            li.appendChild(childrenUl);
        }
        
        return li;
    },
    
    toggleNode(li) {
        const icon = li.querySelector('.node-expand-icon');
        const children = li.querySelector('.node-tree-children');
        
        if (children) {
            const isExpanded = children.style.display !== 'none';
            children.style.display = isExpanded ? 'none' : 'block';
            icon.className = isExpanded ? 'bi bi-chevron-right node-expand-icon me-1' : 'bi bi-chevron-down node-expand-icon me-1';
        }
    },
    
    selectNode(nodeId) {
        this.selectedNodeId = nodeId;
        
        // Update visual selection
        document.querySelectorAll('.node-tree-node').forEach(n => {
            n.classList.remove('selected');
        });
        
        const selectedNode = document.querySelector(`[data-node-id="${nodeId}"] .node-tree-node`);
        if (selectedNode) {
            selectedNode.classList.add('selected');
        }
        
        // Load node details
        this.loadNodeDetail(nodeId);
    },
    
    loadNodeDetail(nodeId) {
        const detailContent = document.getElementById('nodeDetailContent');
        const detailTitle = document.getElementById('nodeDetailTitle');
        
        if (!detailContent) return;
        
        // Show loading state
        detailContent.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        fetch(`/projects/${this.projectId}/nodes/${nodeId}/`, {
            credentials: 'same-origin'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(node => {
                detailTitle.textContent = node.name;
                this.renderNodeDetail(node, detailContent);
            })
            .catch(error => {
                console.error('Error loading node detail:', error);
                detailContent.innerHTML = '<div class="alert alert-danger">Failed to load node details</div>';
            });
    },
    
    renderNodeDetail(node, container) {
        let childrenHtml = '';
        if (node.children && node.children.length > 0) {
            childrenHtml = `
                <div class="mb-3">
                    <label class="form-label fw-bold">Child Nodes</label>
                    <div class="list-group">
                        ${node.children.map(child => `
                            <a href="#" class="list-group-item list-group-item-action" onclick="NodeTreeManager.selectNode(${child.id}); return false;">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${this.escapeHtml(child.name)}</h6>
                                    <small><span class="badge bg-primary">${this.escapeHtml(child.type)}</span></small>
                                </div>
                                <small class="text-muted">${this.escapeHtml(child.breadcrumb)}</small>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = `
            <form id="nodeEditForm" onsubmit="NodeTreeManager.saveNode(event, ${node.id})">
                <div class="mb-3">
                    <label for="editNodeName" class="form-label fw-bold">Name</label>
                    <input type="text" class="form-control" id="editNodeName" name="name" value="${this.escapeHtml(node.name)}" required>
                </div>
                
                <div class="mb-3">
                    <label for="editNodeType" class="form-label fw-bold">Type</label>
                    <select class="form-select" id="editNodeType" name="type" required>
                        {% for type_value, type_label in node_types %}
                        <option value="{{ type_value }}" ${node.type === '{{ type_value }}' ? 'selected' : ''}>{{ type_label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="editNodeParent" class="form-label fw-bold">Parent Node</label>
                    <select class="form-select" id="editNodeParent" name="parent_node_id">
                        <option value="">‚Äî No Parent (Root Node) ‚Äî</option>
                        {% for pnode in project.nodes.all %}
                        <option value="{{ pnode.id }}" ${node.parent_node_id === {{ pnode.id }} ? 'selected' : ''}>{{ pnode.get_breadcrumb }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="editNodeDescription" class="form-label fw-bold">Description</label>
                    <textarea class="form-control" id="editNodeDescription" name="description" rows="4">${this.escapeHtml(node.description || '')}</textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Breadcrumb Path</label>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-diagram-3 me-2"></i>${this.escapeHtml(node.breadcrumb)}
                    </div>
                </div>
                
                ${childrenHtml}
                
                <div class="d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        `;
        
        // Update the parent dropdown to exclude self and descendants
        this.updateParentDropdown(node.id);
    },
    
    updateParentDropdown(nodeId) {
        const parentSelect = document.getElementById('editNodeParent');
        if (!parentSelect) return;
        
        // Disable the current node option
        Array.from(parentSelect.options).forEach(option => {
            if (option.value == nodeId) {
                option.disabled = true;
                option.text = option.text + ' (cannot select self)';
            }
        });
    },
    
    saveNode(event, nodeId) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/projects/${this.projectId}/nodes/${nodeId}/update/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('success', 'Success', data.message);
                // Reload tree to show updated structure
                this.loadTree();
                // Reload node detail
                setTimeout(() => {
                    this.selectNode(nodeId);
                }, 500);
            } else {
                showToast('error', 'Error', data.error);
            }
        })
        .catch(error => {
            console.error('Error saving node:', error);
            showToast('error', 'Error', 'Failed to save node');
        });
    },
    
    getNodeColor(type) {
        const colors = {
            'PROJECT': '#0d6efd',
            'VIEW': '#6610f2',
            'ENTITY': '#198754',
            'PROCESS': '#fd7e14',
            'INTERFACE': '#0dcaf0'
        };
        return colors[type] || '#6c757d';
    },
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    NodeTreeManager.init();
});
</script>
{% endblock %}
