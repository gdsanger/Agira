{% extends "base.html" %}
{% load static %}

{% block title %}{{ project.name }} - Agira{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'projects' %}">Projects</a></li>
        <li class="breadcrumb-item active">{{ project.name }}</li>
    </ol>
</nav>

<!-- 2-Column Layout -->
<div class="detail-layout">
    <!-- Left Column: Main Content (2/3) -->
    <div class="detail-main">
        <!-- Project Header -->
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1 class="mb-2">{{ project.name }}</h1>
                {% if project.description %}
                <div class="text-muted markdown-content">
                    {{ project.description|linebreaks }}
                </div>
                {% else %}
                <p class="text-muted">No description</p>
                {% endif %}
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'project-edit' project.id %}" class="btn btn-sm btn-primary">
                    Edit
                </a>
                <button class="btn btn-sm btn-danger" 
                        hx-post="{% url 'project-delete' project.id %}"
                        hx-confirm="Are you sure you want to delete this project? This action cannot be undone."
                        hx-swap="none"
                        hx-on::after-request="handleDeleteResponse(event)">
                    Delete
                </button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="projectTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab" aria-controls="items">
                    Items <span class="badge bg-secondary">{{ project.items.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes" type="button" role="tab" aria-controls="nodes">
                    Nodes <span class="badge bg-secondary">{{ project.nodes.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="releases-tab" data-bs-toggle="tab" data-bs-target="#releases" type="button" role="tab" aria-controls="releases">
                    Releases <span class="badge bg-secondary">{{ project.releases.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients" type="button" role="tab" aria-controls="clients">
                    Clients <span class="badge bg-secondary">{{ project.clients.count }}</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="projectTabContent">
            <!-- Items Tab -->
            <div class="tab-pane fade show active" id="items" role="tabpanel" aria-labelledby="items-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Items</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                        + Add Item
                    </button>
                </div>
                {% if project.items.count > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in project.items.all %}
                            <tr style="cursor: pointer;" onclick="window.location='{% url 'item-detail' item.id %}'">
                                <td><strong>{{ item.title }}</strong></td>
                                <td>{{ item.type.name }}</td>
                                <td>
                                    {% if item.status == 'Inbox' %}
                                    <span class="badge bg-info">{{ item.status }}</span>
                                    {% elif item.status == 'Backlog' %}
                                    <span class="badge bg-secondary">{{ item.status }}</span>
                                    {% elif item.status == 'Working' %}
                                    <span class="badge bg-primary">{{ item.status }}</span>
                                    {% elif item.status == 'Testing' %}
                                    <span class="badge bg-warning">{{ item.status }}</span>
                                    {% elif item.status == 'ReadyForRelease' %}
                                    <span class="badge bg-success">Ready for Release</span>
                                    {% elif item.status == 'Closed' %}
                                    <span class="badge bg-success">{{ item.status }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ item.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.assigned_to.name|default:"â€”" }}</td>
                                <td>{{ item.updated_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    No items in this project yet.
                </div>
                {% endif %}
            </div>

            <!-- Nodes Tab -->
            <div class="tab-pane fade" id="nodes" role="tabpanel" aria-labelledby="nodes-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Nodes</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addNodeModal">
                        + Add Node
                    </button>
                </div>
                {% if project.nodes.count > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Parent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for node in project.nodes.all %}
                            <tr>
                                <td><strong>{{ node.name }}</strong></td>
                                <td><span class="badge bg-primary">{{ node.type }}</span></td>
                                <td>{{ node.description|truncatewords:10|default:"â€”" }}</td>
                                <td>{{ node.parent_node.name|default:"â€”" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    No nodes in this project yet.
                </div>
                {% endif %}
            </div>

            <!-- Releases Tab -->
            <div class="tab-pane fade" id="releases" role="tabpanel" aria-labelledby="releases-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Releases</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addReleaseModal">
                        + Add Release
                    </button>
                </div>
                {% if project.releases.count > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Version</th>
                                <th>Status</th>
                                <th>Risk</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for release in project.releases.all %}
                            <tr>
                                <td><strong>{{ release.name }}</strong></td>
                                <td>{{ release.version }}</td>
                                <td>
                                    {% if release.status == 'Planned' %}
                                    <span class="badge bg-info">{{ release.status }}</span>
                                    {% elif release.status == 'Working' %}
                                    <span class="badge bg-primary">{{ release.status }}</span>
                                    {% elif release.status == 'Closed' %}
                                    <span class="badge bg-success">{{ release.status }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ release.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if release.risk == 'Low' %}
                                    <span class="badge bg-success">{{ release.risk }}</span>
                                    {% elif release.risk == 'Normal' %}
                                    <span class="badge bg-info">{{ release.risk }}</span>
                                    {% elif release.risk == 'High' %}
                                    <span class="badge bg-warning">{{ release.risk }}</span>
                                    {% elif release.risk == 'VeryHigh' %}
                                    <span class="badge bg-danger">Very High</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ release.risk }}</span>
                                    {% endif %}
                                </td>
                                <td>{% if release.update_date %}{{ release.update_date|date:"Y-m-d" }}{% else %}â€”{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    No releases in this project yet.
                </div>
                {% endif %}
            </div>

            <!-- Clients Tab -->
            <div class="tab-pane fade" id="clients" role="tabpanel" aria-labelledby="clients-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Clients</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        + Add Client
                    </button>
                </div>
                {% if project.clients.count > 0 %}
                <div class="list-group">
                    {% for client in project.clients.all %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ client.name }}</span>
                        <button class="btn btn-sm btn-danger" 
                                hx-post="{% url 'project-remove-client' project.id %}"
                                hx-vals='{"organisation_id": "{{ client.id }}"}'
                                hx-swap="none"
                                hx-on::after-request="handleClientResponse(event)">
                            Remove
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    No clients assigned to this project yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Sidebar (1/3) -->
    <div class="detail-sidebar">
        <!-- Status Card -->
        <div class="project-info-card">
            <div class="project-info-label">Status</div>
            <div class="project-info-value">
                {% if project.status == 'New' %}
                <span class="badge bg-info fs-6">{{ project.status }}</span>
                {% elif project.status == 'Working' %}
                <span class="badge bg-primary fs-6">{{ project.status }}</span>
                {% elif project.status == 'Finished' %}
                <span class="badge bg-success fs-6">{{ project.status }}</span>
                {% elif project.status == 'Canceled' %}
                <span class="badge bg-secondary fs-6">{{ project.status }}</span>
                {% else %}
                <span class="badge bg-secondary fs-6">{{ project.status }}</span>
                {% endif %}
            </div>
        </div>

        <!-- Repository Card -->
        {% if project.github_owner and project.github_repo %}
        <div class="project-info-card">
            <div class="project-info-label">Repository</div>
            <div class="project-info-value">
                <a href="https://github.com/{{ project.github_owner }}/{{ project.github_repo }}" 
                   target="_blank" 
                   class="d-flex align-items-center gap-2">
                    <span>{{ project.github_owner }}/{{ project.github_repo }}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
                        <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
                    </svg>
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Item Statistics -->
        <div class="project-info-card">
            <div class="project-info-label">Item Statistics</div>
            <div class="project-info-value">
                <div class="d-flex flex-column gap-2">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">ðŸ“¥ Inbox</span>
                        <span>{{ project.items.all|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">ðŸ“‹ Backlog</span>
                        <span>{{ project.items.all|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">âš¡ Working</span>
                        <span>{{ project.items.all|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">âœ… Total</span>
                        <strong>{{ project.items.count }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals for Adding Resources (kept for backward compatibility) -->
{% include "partials/project_modals.html" %}

<!-- Toast Container -->
<div class="toast-container"></div>
{% endblock %}

{% block extra_js %}
<script>
// Handle delete response
function handleDeleteResponse(event) {
    const xhr = event.detail.xhr;
    
    if (xhr.status === 200) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showToast('success', 'Success', response.message || 'Project deleted successfully');
                setTimeout(() => {
                    window.location.href = response.redirect || '/projects/';
                }, 1000);
            } else {
                showToast('error', 'Error', response.error || 'Failed to delete project');
            }
        } catch (e) {
            showToast('error', 'Error', 'An unexpected error occurred');
        }
    } else {
        showToast('error', 'Error', 'Failed to delete project');
    }
}

// Handle client add/remove response
function handleClientResponse(event) {
    const xhr = event.detail.xhr;
    
    if (xhr.status === 200) {
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showToast('success', 'Success', response.message);
                // Reload page to update client list
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('error', 'Error', response.error || 'Operation failed');
            }
        } catch (e) {
            showToast('error', 'Error', 'An unexpected error occurred');
        }
    } else {
        showToast('error', 'Error', 'Operation failed');
    }
}

// Toast notification function
function showToast(type, title, message) {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(t => {
        const bsToast = bootstrap.Toast.getInstance(t);
        if (bsToast) bsToast.hide();
    });
    
    // Create toast container if it doesn't exist
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    
    // Create toast element
    const toastEl = document.createElement('div');
    toastEl.className = `toast toast-${type}`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    toastEl.innerHTML = `
        <div class="toast-header">
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    container.appendChild(toastEl);
    
    const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
    toast.show();
    
    // Remove from DOM after hidden
    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}
</script>
{% endblock %}
